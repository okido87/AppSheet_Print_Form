<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê∆°n ƒê·∫∑t H√†ng - M·ªôc ·∫§n</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Times New Roman', Times, serif;
            background-color: white;
            padding: 15px;
            font-size: 13px;
        }

        .container {
            max-width: 210mm;
            margin: 0 auto;
            background: white;
        }

        /* Print Controls */
        .print-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #ddd;
        }

        .print-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.3s;
        }

        .print-btn:hover {
            background: #c0392b;
        }

        .print-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .logo-section {
            display: flex;
            align-items: center;
        }

        .logo-circle {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #ff4444, #ffaa00, #44aa44);
            border-radius: 50%;
            margin-right: 10px;
        }

        .logo-text h1 {
            color: #e74c3c;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .logo-subtext {
            font-size: 9px;
            color: #888;
            line-height: 1.2;
        }

        .contact-info {
            text-align: right;
            font-size: 14px;
        }

        .phone-icon::before {
            content: "üìû";
            margin-right: 5px;
        }

        .website {
            background: #e74c3c;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 13px;
            display: inline-block;
            margin-top: 5px;
        }

        /* Title */
        .title {
            text-align: center;
            font-size: 23px;
            font-weight: bold;
            margin: 0 0 5px 0;
            letter-spacing: 2px;
        }

        .order-number {
            text-align: center;
            font-size: 13px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        /* Customer Info Table */
        .customer-info {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #000;
            margin-bottom: 15px;
        }

        .customer-info td {
            border: 1px solid #000;
            padding: 6px 8px;
            font-size: 13px;
            vertical-align: top;
        }

        /* Product Table */
        .product-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #000;
            margin-bottom: 15px;
        }

        .product-table th,
        .product-table td {
            border: 1px solid #000;
            padding: 6px 4px;
            text-align: center;
            font-size: 13px;
            vertical-align: middle;
        }

        .product-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            height: 40px;
        }

        .product-name {
            text-align: left !important;
            width: 205px;
            padding-left: 8px !important;
            font-weight: bold;
        }

        .stt-col {
            width: 30px;
        }

        .dvt-col {
            width: 40px;
        }

        .quantity-col {
            width: 60px;
        }

        .price-col {
            width: 70px;
        }

        .total-col {
            width: 100px;
        }

        .product-table tr {
            height: auto;
            /* Cho ph√©p h√†ng t·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh */
        }

        .product-table td {
            vertical-align: middle;
            /* CƒÉn gi·ªØa n·ªôi dung theo chi·ªÅu d·ªçc */
            height: auto;
        }

        .image-col {
            width: 80px;
            min-width: 80px;
            vertical-align: middle;
        }

        .delivery-col {
            width: 60px;
        }

        .product-image {
            width: 70px;
            height: auto;
            /* Thay ƒë·ªïi t·ª´ 50px th√†nh auto */
            min-height: 50px;
            /* Th√™m chi·ªÅu cao t·ªëi thi·ªÉu */
            background: #f0f0f0;
            margin: 2px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 2px;
            /* Th√™m padding */
        }

        .product-image img {
            max-width: 100%;
            max-height: none;
            /* B·ªè gi·ªõi h·∫°n chi·ªÅu cao */
            width: auto;
            height: auto;
            object-fit: contain;
            /* Thay ƒë·ªïi t·ª´ cover th√†nh contain */
            cursor: pointer;
            border-radius: 2px;
        }

        .product-image .no-image {
            font-size: 10px;
            color: #999;
            text-align: center;
        }

        /* Image loading indicator */
        .image-loading {
            font-size: 9px;
            color: #666;
            text-align: center;
        }

        .total-row {
            font-weight: bold;
        }

        .total-row td {
            font-size: 13px;
        }

        /* Notes */
        .notes {
            border: 1px solid #000;
            padding: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            font-style: italic;
        }

        /* Bottom Section */
        .bottom-section {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
        }

        .left-info {
            width: 60%;
            border: 1px solid #000;
            border-right: none;
            padding: 10px;
            font-size: 13px;
            line-height: 1.4;
            color: #081b3af0;
        }

        .right-info {
            flex: 1;
            border: 1px solid #000;
            padding: 10px;
            font-size: 13px;
            line-height: 1.4;
        }

        .right-info h4 {
            font-size: 13px;
            margin-bottom: 8px;
            text-align: center;
        }

        /* Signature */
        .signature-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #000;
        }

        .signature-table td {
            border: 1px solid #000;
            padding: 6px 8px;
            text-align: center;
            font-size: 13px;
            font-weight: bold;
            vertical-align: top;
            width: 33.33%;
        }

        .signature-name {
            margin-top: 30px;
            font-weight: bold;
        }

        /* Format numbers */
        .number {
            text-align: right;
        }

        /* Loading & Error */
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }

        .error {
            color: red;
            text-align: center;
            padding: 20px;
        }

        .warning {
            color: orange;
            text-align: center;
            padding: 20px;
            font-style: italic;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        /* Modal styles for image viewing */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9);
        }

        .modal-content {
            margin: auto;
            display: block;
            position: relative;
            top: 50%;
            transform: translateY(-50%);
            width: auto;
            height: auto;
            max-width: 80%;
            max-height: 80vh;
        }

        #modalImage {
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 80vh;
            display: block;
            margin: auto;
            object-fit: contain;
        }

        .close {
            position: absolute;
            right: 15px;
            top: -40px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Print Status */
        .print-status {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 5px;
            z-index: 10000;
            display: none;
        }

        @media print {
            .product-image {
                height: auto !important;
                min-height: 40px !important;
                padding: 1px !important;
            }

            .product-image img {
                max-width: 70px !important;
                max-height: none !important;
                width: auto !important;
                height: auto !important;
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }

            .product-table tr {
                height: auto !important;
                page-break-inside: avoid;
            }
        }

        /* Print Styles */
        @media print {
            html {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }

            body {
                padding: 0;
                margin: 0;
                font-size: 13px;
                background: white !important;
            }

            .container {
                max-width: none;
                width: 100%;
                margin: 0;
                padding: 0;
            }

            .print-controls {
                display: none !important;
            }

            .modal {
                display: none !important;
            }

            .loading-overlay {
                display: none !important;
            }

            /* Ensure tables print properly */
            .customer-info,
            .product-table,
            .signature-table {
                border-collapse: collapse;
                page-break-inside: avoid;
            }

            .product-table {
                page-break-inside: auto;
            }

            .product-table tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            .product-table thead {
                display: table-header-group;
            }

            .product-table tfoot {
                display: table-footer-group;
            }

            /* Hide cursor pointer on images */
            .product-image img {
                cursor: default;
            }

            /* Page breaks */
            .signature-table {
                page-break-inside: avoid;
                margin-top: 20px;
            }

            .bottom-section {
                page-break-inside: avoid;
            }

            /* Print-specific adjustments */
            .title {
                font-size: 24px;
            }

            /* ƒê·ªìng b·ªô padding cho t·∫•t c·∫£ cells */
            .customer-info td,
            .product-table th,
            .product-table td,
            .signature-table td {
                padding: 6px 8px !important;
                /* Gi·ªëng nh∆∞ tr√™n web */
                font-size: 12px !important;
                /* Gi·ªëng nh∆∞ tr√™n web */
            }

            /* ƒê·ªìng b·ªô line-height */
            .left-info,
            .right-info {
                font-size: 12px !important;
                /* Gi·ªëng nh∆∞ tr√™n web */
                line-height: 1.4 !important;
            }
        }
    </style>
</head>

<body>
    <!-- Print Controls -->
    <div class="print-controls">
        <button class="print-btn" onclick="printDocument()" id="printBtn">
            üñ®Ô∏è In ƒë∆°n h√†ng
        </button>
    </div>

    <!-- Print Status -->
    <div class="print-status" id="printStatus">
        ƒêang chu·∫©n b·ªã in...
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <img id="modalImage" src="" alt="Enlarged image">
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div style="text-align: center;">
            <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <img width="100%" src="https://poalninh.github.io/PostPrint/logo moc an-01.png" alt="">
            </div>
        </div>

        <!-- Title -->
        <div class="title">ƒê∆†N ƒê·∫∂T H√ÄNG</div>
        <div class="order-number" id="orderNumber">S·ªë: <span id="soPhieu">ƒêang t·∫£i...</span></div>

        <!-- Customer Info -->
        <table class="customer-info">
            <tr>
                <td colspan="2" style="width: 33.3%;">Kh√°ch h√†ng: <strong id="tenKhachHang">ƒêang t·∫£i...</strong></td>
                <td style="width: 33.3%;">Ng√†y l·∫≠p: <strong id="ngayLap">ƒêang t·∫£i...</strong></td>
            </tr>
            <tr>
                <td colspan="2">ƒê·ªãa ch·ªâ giao: <strong id="diaChiGiao">ƒêang t·∫£i...</strong></td>
                <td>Ng∆∞·ªùi l·∫≠p ƒë∆°n: <strong id="loaiKhachHang">ƒêang t·∫£i...</strong></td>
            </tr>
            <tr>
                <td>Ng∆∞·ªùi nh·∫≠n h√†ng: <strong id="nguoiNhanHang">ƒêang t·∫£i...</strong></td>
                <td style="width: 33.3%;">S·ªë ƒëi·ªán tho·∫°i: <strong id="soDienThoai">ƒêang t·∫£i...</strong></td>
                <td>Ng√†y h·∫πn tr·∫£: <strong id="hanGiaoHang">ƒêang t·∫£i...</strong></td>
            </tr>
        </table>

        <!-- Product Table -->
        <table class="product-table">
            <thead>
                <tr>
                    <th class="stt-col">STT</th>
                    <th class="product-name">T√™n s·∫£n ph·∫©m</th>
                    <th class="dvt-col">ƒêVT</th>
                    <th class="quantity-col">S·ªë l∆∞·ª£ng</th>
                    <th class="price-col">ƒê∆°n gi√°<br>(ch∆∞a VAT)</th>
                    <th class="total-col">Th√†nh ti·ªÅn<br>(ch∆∞a VAT)</th>
                    <th class="image-col">H√¨nh ·∫£nh</th>
                    <th class="delivery-col">Ghi ch√∫</th>
                </tr>
            </thead>
            <tbody id="productTableBody">
                <tr>
                    <td colspan="8" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</td>
                </tr>
            </tbody>
        </table>

        <!-- Bottom Section -->
        <div class="bottom-section">
            <div class="left-info">
                <p style="color: #000;"><strong>Ghi ch√∫: <span id="ghichudonhang"></span></strong></p>
                <p>- S·ªë l∆∞·ª£ng giao h√†ng: ¬±10%</p>
                <p>- ƒê·ªëi v·ªõi nh·ªØng s·∫£n ph·∫©m T√∫i n·∫øu nguy√™n li·ªáu c·ªßa Qu√Ω kh√°ch c√≥ ch·ª©a ho·∫°t ch·∫•t c√≥ t√≠nh ƒÉn m√≤n m·∫°nh ƒë·ªÅ xu·∫•t Qu√Ω kh√°ch vui l√≤ng d√πng m√°y gia t·ªëc test tr∆∞·ªõc khi s·∫£n xu·∫•t s·∫£n ph·∫©m h√†ng lo·∫°t.</p>
            </div>
            <div class="right-info">
                <p><strong>TH√îNG TIN CHUY·ªÇN KHO·∫¢N:</strong></p>
                <p><strong>C√îNG TY TNHH QU·∫¢NG C√ÅO M·ªòC ·∫§N</strong></p>
                <p><strong>STK: 157938519</strong></p>
                <p><strong>T·∫°i Ng√¢n H√†ng TMCP √Å Ch√¢u, CN Ph√∫ L√¢m,</strong></p>
                <p><strong>PGD L√™ VƒÉn Qu·ªõi</strong></p>
            </div>
        </div>

        <!-- Signature Section -->
        <table class="signature-table">
            <tr>
                <td><strong>X√ÅC NH·∫¨N ƒê∆†N ƒê·∫∂T H√ÄNG</strong></td>
                <td><strong>Ph√™ duy·ªát</strong></td>
                <td><strong>Ng∆∞·ªùi l·∫≠p</strong></td>
            </tr>
            <tr>
                <td>
                    <div style="height: 50px;"></div>
                </td>
                <td>
                    <div style="height: 50px;"></div>
                    <div class="signature-name" id="nguoiDuyet">ƒêang t·∫£i...</div>
                </td>
                <td>
                    <div style="height: 30px;"></div>
                    <div class="signature-name" id="nguoiLapKy">ƒêang t·∫£i...</div>
                </td>
            </tr>
        </table>
    </div>

    <!-- <script>
        // API Configuration
        const API_CONFIG = {
            APP_ID: '323b6578-b51a-425a-9775-c84d2d8d0904',
            ACCESS_KEY: 'V2-MipF3-d6wQk-t6AIN-zzz0j-HglL4-Uq2Yp-EckHF-m3lOV',
            REGION: 'www',
            BASE_URL: 'https://www.appsheet.com/api/v2/apps',
            APP_NAME: 'MocAnSystem-777046908'
        };

        // Set document title for printing
        function setDocumentTitle(soPhieu) {
            if (soPhieu && soPhieu !== 'ƒêang t·∫£i...') {
                document.title = soPhieu;
            }
        }

        // State Management
        let state = {
            orderData: null,
            loading: false
        };

        // Print Functions
        const PrintManager = {
            // Print document
            print: async () => {
                try {
                    // Check if data is loaded
                    if (!state.orderData) {
                        alert('Vui l√≤ng ƒë·ª£i d·ªØ li·ªáu t·∫£i xong tr∆∞·ªõc khi in!');
                        return;
                    }

                    // Disable print button during printing
                    const printBtn = document.getElementById('printBtn');
                    const originalText = printBtn.innerHTML;
                    printBtn.disabled = true;
                    printBtn.innerHTML = '‚è≥ ƒêang in...';

                    // Show print status
                    PrintManager.showPrintStatus('ƒêang chu·∫©n b·ªã in...');

                    // Set document title for printing filename
                    const soPhieu = document.getElementById('soPhieu').textContent;
                    if (soPhieu && soPhieu !== 'ƒêang t·∫£i...') {
                        document.title = `DonHang_${soPhieu}`;
                    }

                    // Wait for images to load
                    await PrintManager.waitForImages();

                    // Hide print status
                    PrintManager.hidePrintStatus();

                    // Trigger print
                    window.print();

                    // Re-enable print button
                    setTimeout(() => {
                        printBtn.disabled = false;
                        printBtn.innerHTML = originalText;
                    }, 1000);

                } catch (error) {
                    console.error('Print error:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi in. Vui l√≤ng th·ª≠ l·∫°i!');

                    // Re-enable print button
                    const printBtn = document.getElementById('printBtn');
                    printBtn.disabled = false;
                    printBtn.innerHTML = 'üñ®Ô∏è In ƒë∆°n h√†ng';

                    PrintManager.hidePrintStatus();
                }
            },

            // Wait for all images to load
            waitForImages: () => {
                return new Promise((resolve) => {
                    const images = document.querySelectorAll('.product-image img');
                    let loadedCount = 0;
                    const totalImages = images.length;

                    if (totalImages === 0) {
                        resolve();
                        return;
                    }

                    const checkComplete = () => {
                        loadedCount++;
                        if (loadedCount >= totalImages) {
                            resolve();
                        }
                    };

                    images.forEach((img) => {
                        if (img.complete) {
                            checkComplete();
                        } else {
                            img.onload = checkComplete;
                            img.onerror = checkComplete;
                        }
                    });

                    // Timeout after 5 seconds
                    setTimeout(() => {
                        resolve();
                    }, 5000);
                });
            },

            // Show print status
            showPrintStatus: (message) => {
                const status = document.getElementById('printStatus');
                status.textContent = message;
                status.style.display = 'block';
            },

            // Hide print status
            hidePrintStatus: () => {
                const status = document.getElementById('printStatus');
                status.style.display = 'none';
            }
        };

        // Global print function
        function printDocument() {
            PrintManager.print();
        }

        // API Service
        const apiService = {
            createAxiosInstance() {
                return axios.create({
                    baseURL: `${API_CONFIG.BASE_URL}/${API_CONFIG.APP_ID}/tables`,
                    headers: {
                        'ApplicationAccessKey': API_CONFIG.ACCESS_KEY,
                        'Content-Type': 'application/json'
                    }
                });
            },

            async request(tableName, action, data = {}, select = {}) {
                try {
                    const api = this.createAxiosInstance();
                    const requestBody = {
                        Action: action,
                        Properties: {
                            UserSettings: {
                                "User name": "Admin",
                                "Password": "123456"
                            },
                            ...select
                        },
                        ...data
                    };

                    const response = await api.post(`/${tableName}/Action`, requestBody);
                    return response.data;
                } catch (error) {
                    console.error('API request failed:', error);
                    throw error;
                }
            },

            // L·∫•y th√¥ng tin s·∫£n ph·∫©m t·ª´ DMSP
            async getProductInfo(maSP) {
                try {
                    console.log(`Fetching product info for M√£ SP: ${maSP}`);
                    const response = await this.request('DMSP', 'Find', {}, {
                        Selector: `Filter(DMSP, [M√£ SP] = '${maSP}')`
                    });
                    console.log(`Product info response for ${maSP}:`, response);
                    return response && response.length > 0 ? response[0] : null;
                } catch (error) {
                    console.error('Error fetching product info:', error);
                    return null;
                }
            },

            // L·∫•y th√¥ng tin nhi·ªÅu s·∫£n ph·∫©m c√πng l√∫c
            async getMultipleProductsInfo(productCodes) {
                try {
                    console.log('Fetching multiple product info for:', productCodes);

                    // T·∫°o filter condition cho nhi·ªÅu s·∫£n ph·∫©m
                    const filterConditions = productCodes.map(code => `[M√£ SP] = '${code}'`).join(' OR ');
                    const selector = `Filter(DMSP, ${filterConditions})`;

                    const response = await this.request('DMSP', 'Find', {}, {
                        Selector: selector
                    });

                    console.log('Multiple products response:', response);
                    return response || [];
                } catch (error) {
                    console.error('Error fetching multiple products info:', error);
                    return [];
                }
            },

            getImageUrl: (fileName) => {
                if (!fileName) return '';

                const cleanFileName = fileName.trim();
                console.log('Original fileName:', cleanFileName);

                const baseUrl = 'https://www.appsheet.com/image/getimageurl';

                const params = new URLSearchParams({
                    appName: API_CONFIG.APP_NAME,
                    tableName: 'DMSP',
                    fileName: cleanFileName
                });

                const finalUrl = `${baseUrl}?${params.toString()}`;
                console.log('Generated URL:', finalUrl);

                return finalUrl;
            }
        };

        // Image handling functions
        const imageHandler = {
            updateImageInContainer: (container, imageUrl) => {
                if (!container || !imageUrl) {
                    if (container) {
                        container.innerHTML = '<div class="no-image">No Image</div>';
                    }
                    return;
                }

                console.log('Loading image with URL:', imageUrl);
                container.innerHTML = '<div class="image-loading">ƒêang t·∫£i...</div>';

                const newImg = document.createElement('img');
                newImg.alt = 'Product Image';

                newImg.onload = function () {
                    console.log('Image loaded successfully:', imageUrl);

                    // T·∫°o th·∫ª <a> bao quanh ·∫£nh
                    const linkElement = document.createElement('a');
                    linkElement.href = imageUrl;
                    linkElement.target = '_blank'; // M·ªü trong tab m·ªõi
                    linkElement.style.display = 'block';
                    linkElement.style.cursor = 'pointer';

                    // ƒê·∫∑t ·∫£nh v√†o trong th·∫ª <a>
                    linkElement.appendChild(this);

                    // Thay th·∫ø n·ªôi dung container
                    container.innerHTML = '';
                    container.appendChild(linkElement);
                };

                newImg.onerror = function () {
                    console.error('Image load failed:', imageUrl);
                    container.innerHTML = '<div class="no-image" style="font-size: 9px;">L·ªói t·∫£i ·∫£nh</div>';
                };

                newImg.src = imageUrl;
            },

            showModal: (imgSrc) => {
                const modal = document.getElementById('imageModal');
                const modalImg = document.getElementById('modalImage');
                if (modal && modalImg) {
                    modal.style.display = 'block';
                    modalImg.src = imgSrc;
                }
            }
        };

        // Loading Management
        const showLoading = () => {
            document.getElementById('loadingOverlay').style.display = 'flex';
            state.loading = true;
        };

        const hideLoading = () => {
            document.getElementById('loadingOverlay').style.display = 'none';
            state.loading = false;
        };

        // Utility Functions
        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return new Intl.NumberFormat('vi-VN').format(num);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                return date.toLocaleDateString('vi-VN');
            } catch (error) {
                return dateString;
            }
        }

        function numberToWords(num) {
            if (num === 0 || num === null || num === undefined) return 'kh√¥ng ƒë·ªìng';

            const ones = ['', 'm·ªôt', 'hai', 'ba', 'b·ªën', 'nƒÉm', 's√°u', 'b·∫£y', 't√°m', 'ch√≠n'];
            const tens = ['', '', 'hai m∆∞∆°i', 'ba m∆∞∆°i', 'b·ªën m∆∞∆°i', 'nƒÉm m∆∞∆°i', 's√°u m∆∞∆°i', 'b·∫£y m∆∞∆°i', 't√°m m∆∞∆°i', 'ch√≠n m∆∞∆°i'];
            const scales = ['', 'ngh√¨n', 'tri·ªáu', 't·ª∑'];

            function convertHundreds(n) {
                let result = '';

                const hundred = Math.floor(n / 100);
                const remainder = n % 100;
                const ten = Math.floor(remainder / 10);
                const one = remainder % 10;

                if (hundred > 0) {
                    result += ones[hundred] + ' trƒÉm';
                }

                if (ten > 1) {
                    result += (result ? ' ' : '') + tens[ten];
                    if (one > 0) {
                        result += ' ' + ones[one];
                    }
                } else if (ten === 1) {
                    result += (result ? ' ' : '') + 'm∆∞·ªùi';
                    if (one > 0) {
                        result += ' ' + ones[one];
                    }
                } else if (one > 0 && hundred > 0) {
                    result += ' l·∫ª ' + ones[one];
                } else if (one > 0) {
                    result += (result ? ' ' : '') + ones[one];
                }

                return result;
            }

            function convertNumber(num) {
                if (num === 0) return 'kh√¥ng';

                let result = '';
                let scaleIndex = 0;

                while (num > 0) {
                    const chunk = num % 1000;
                    if (chunk !== 0) {
                        const chunkWords = convertHundreds(chunk);
                        const scale = scales[scaleIndex];
                        result = chunkWords + (scale ? ' ' + scale : '') + (result ? ' ' + result : '');
                    }
                    num = Math.floor(num / 1000);
                    scaleIndex++;
                }

                return result;
            }

            const words = convertNumber(Math.floor(num));
            return words.charAt(0).toUpperCase() + words.slice(1) + ' ƒë·ªìng';
        }

        // Fetch Order Data
        async function fetchOrderData(orderId) {
            try {
                showLoading();

                const [header, details] = await Promise.all([
                    apiService.request('DonHang', 'Find', {}, {
                        Selector: `Filter(DonHang, [S·ªë ƒêH] = '${orderId}')`
                    }),
                    apiService.request('CTDonHang', 'Find', {}, {
                        Selector: `Filter(CTDonHang, [S·ªë ƒêH] = '${orderId}')`
                    })
                ]);

                if (!header || header.length === 0) {
                    throw new Error(`Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng v·ªõi s·ªë: ${orderId}`);
                }

                state.orderData = {
                    header: header[0],
                    details: details || []
                };

                return state.orderData;
            } catch (error) {
                console.error('Error fetching order:', error);
                throw error;
            } finally {
                hideLoading();
            }
        }

        // Populate Order Header
        function populateOrderHeader(donHang) {
            try {
                const soPhieu = donHang['S·ªë ƒêH'] || ' ';
                document.getElementById('soPhieu').textContent = soPhieu;

                // Set document title for printing
                setDocumentTitle(soPhieu);

                document.getElementById('tenKhachHang').textContent = donHang['T√™n kh√°ch h√†ng'] || ' ';
                document.getElementById('ngayLap').textContent = formatDate(donHang['Ng√†y']);
                document.getElementById('diaChiGiao').textContent = donHang['ƒê·ªãa ch·ªâ nh·∫≠n h√†ng'] || ' ';
                document.getElementById('loaiKhachHang').textContent = donHang['T√™n Ng∆∞·ªùi nh·∫≠n ƒë∆°n'] || ' ';
                document.getElementById('nguoiNhanHang').textContent = donHang['Ng∆∞·ªùi nh·∫≠n h√†ng'] || ' ';
                document.getElementById('soDienThoai').textContent = donHang['S·ªë ƒëi·ªán tho·∫°i'] || ' ';
                document.getElementById('hanGiaoHang').textContent = formatDate(donHang['H·∫°n giao h√†ng']);
                document.getElementById('nguoiDuyet').textContent = donHang['Ng∆∞·ªùi duy·ªát'] || ' ';
                document.getElementById('nguoiLapKy').textContent = donHang['T√™n ng∆∞·ªùi t·∫°o'] || ' ';
                document.getElementById('ghichudonhang').textContent = donHang['Ghi ch√∫'] || '';
            } catch (error) {
                console.error('Error populating header:', error);
                throw error;
            }
        }

        // Populate Product Table
        async function populateProductTable(chiTietDonHang) {
            const tbody = document.getElementById('productTableBody');
            tbody.innerHTML = '';

            try {
                if (chiTietDonHang.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="warning">‚ö†Ô∏è Kh√¥ng c√≥ chi ti·∫øt s·∫£n ph·∫©m cho ƒë∆°n h√†ng n√†y</td></tr>';
                    return;
                }

                // Thu th·∫≠p t·∫•t c·∫£ m√£ s·∫£n ph·∫©m
                const productCodes = chiTietDonHang.map(item => {
                    return item['M√£ SP'] || item['MaSP'] || item['Product ID'] || item['ProductID'];
                }).filter(code => code); // Lo·∫°i b·ªè c√°c gi√° tr·ªã null/undefined

                console.log('All product codes:', productCodes);

                // L·∫•y th√¥ng tin t·∫•t c·∫£ s·∫£n ph·∫©m c√πng l√∫c
                const allProductsInfo = await apiService.getMultipleProductsInfo(productCodes);
                console.log('All products info:', allProductsInfo);

                // T·∫°o map ƒë·ªÉ tra c·ª©u nhanh th√¥ng tin s·∫£n ph·∫©m
                const productInfoMap = new Map();
                allProductsInfo.forEach(product => {
                    const maSP = product['M√£ SP'];
                    if (maSP) {
                        productInfoMap.set(maSP, product);
                    }
                });

                console.log('Product info map:', productInfoMap);

                // T·∫°o t·∫•t c·∫£ rows v√† load h√¨nh ·∫£nh song song
                const imageLoadPromises = [];

                for (let index = 0; index < chiTietDonHang.length; index++) {
                    const item = chiTietDonHang[index];

                    const soLuong = parseFloat(item['S·ªë l∆∞·ª£ng']) || 0;
                    const donGia = parseFloat(item['ƒê∆°n gi√°']) || 0;
                    const thanhTien = parseFloat(item['Th√†nh ti·ªÅn']) || (soLuong * donGia);

                    const row = document.createElement('tr');

                    row.innerHTML = `
               <td>${index + 1}</td>
               <td class="product-name">${item['T√™n S·∫£n ph·∫©m'] || ' '} - ${item['Quy c√°ch'] || ' '} cm - ${item['Ch·∫•t li·ªáu lo·∫°i v·∫≠t t∆∞'] || ' '}</td>
               <td>${item['ƒêvt'] || 'C√°i'}</td>
               <td class="number">${formatNumber(soLuong)}</td>
               <td class="number">${formatNumber(donGia)}</td>
               <td class="number">${formatNumber(thanhTien)}</td>
               <td>
                   <div class="product-image">
                       <div class="image-loading">ƒêang t·∫£i...</div>
                   </div>
               </td>
               <td>${item['Ghi ch√∫'] || ''}</td>
           `;
                    tbody.appendChild(row);

                    // L·∫•y M√£ SP t·ª´ CTDonHang
                    const maSP = item['M√£ SP'] || item['MaSP'] || item['Product ID'] || item['ProductID'];

                    if (maSP && productInfoMap.has(maSP)) {
                        const productInfo = productInfoMap.get(maSP);
                        console.log(`Product info for ${maSP}:`, productInfo);

                        // T√¨m tr∆∞·ªùng h√¨nh ·∫£nh trong DMSP
                        const imageFileName = productInfo['H√¨nh ·∫£nh'] ||
                            productInfo['Image'] ||
                            productInfo['Photo'] ||
                            productInfo['picture'] ||
                            productInfo['file'] ||
                            productInfo['File'] ||
                            productInfo['attachment'] ||
                            productInfo['Attachment'];

                        console.log(`Image filename for ${maSP}:`, imageFileName);

                        const container = row.querySelector('.product-image');

                        if (imageFileName) {
                            const imageUrl = apiService.getImageUrl(imageFileName);
                            console.log(`Image URL for ${maSP}:`, imageUrl);

                            // Th√™m promise load h√¨nh ·∫£nh v√†o danh s√°ch
                            imageLoadPromises.push(
                                new Promise((resolve) => {
                                    imageHandler.updateImageInContainer(container, imageUrl);
                                    // Kh√¥ng c·∫ßn ƒë·ª£i image load ho√†n th√†nh, ch·ªâ c·∫ßn b·∫Øt ƒë·∫ßu load
                                    setTimeout(resolve, 50); // Delay nh·ªè ƒë·ªÉ tr√°nh spam requests
                                })
                            );
                        } else {
                            console.log(`No image found for product ${maSP}`);
                            if (container) {
                                container.innerHTML = '<div class="no-image">No Image</div>';
                            }
                        }
                    } else {
                        console.log(`No product info found for ${maSP}`);
                        const container = row.querySelector('.product-image');
                        if (container) {
                            if (maSP) {
                                container.innerHTML = '<div class="no-image">Kh√¥ng t√¨m th·∫•y SP</div>';
                            } else {
                                container.innerHTML = '<div class="no-image">Kh√¥ng c√≥ m√£ SP</div>';
                            }
                        }
                    }
                }

                // L·∫•y th√¥ng tin t·ª´ state.orderData.header (ƒë√£ load t·ª´ b·∫£ng DonHang)
                const donHang = state.orderData.header;

                // L·∫•y c√°c th√¥ng tin t·ª´ b·∫£ng DonHang
                const thanhTienFromDB = parseFloat(donHang['Th√†nh ti·ªÅn'] || 0);
                const vatRate = parseFloat(donHang['VAT'] || 0);
                const tienVAT = thanhTienFromDB * vatRate;
                const tongTienFromDB = parseFloat(donHang['T·ªïng ti·ªÅn'] || 0);

                // Format VAT th√†nh ph·∫ßn trƒÉm (0.08 -> 8%)
                const vatPercent = `${Math.round(vatRate * 100)}%`;

                // Format c√°c s·ªë
                const thanhTienDisplay = formatNumber(thanhTienFromDB);
                const tienVATDisplay = formatNumber(tienVAT);
                const tongTienDisplay = formatNumber(tongTienFromDB);

                // Add total row
                const totalRow = document.createElement('tr');
                totalRow.className = 'total-row';
                totalRow.innerHTML = `
           <td colspan="5" style="padding: 6px; text-align: center; font-weight: bold;">T·ªïng ti·ªÅn</td>
           <td style="padding: 6px; text-align: right; font-weight: bold;">${thanhTienDisplay} VNƒê</td>
           <td colspan="2"></td>
       `;
                tbody.appendChild(totalRow);

                // Add VAT row
                const vatRow = document.createElement('tr');
                vatRow.className = 'total-row';
                vatRow.innerHTML = `
           <td colspan="5" style="padding: 6px; text-align: center; font-weight: bold;">VAT ${vatPercent}</td>
           <td style="padding: 6px; text-align: right; font-weight: bold;">${tienVATDisplay} VNƒê</td>
           <td colspan="2"></td>
       `;
                tbody.appendChild(vatRow);

                // Add grand total row
                const grandTotalRow = document.createElement('tr');
                grandTotalRow.className = 'total-row';
                grandTotalRow.innerHTML = `
           <td colspan="5" style="padding: 6px; text-align: center; font-weight: bold;">T·ªîNG TI·ªÄN THANH TO√ÅN</td>
           <td style="padding: 6px; text-align: right; font-weight: bold;">${tongTienDisplay} VNƒê</td>
           <td colspan="2"></td>
       `;
                tbody.appendChild(grandTotalRow);

                // Add notes row - s·ª≠ d·ª•ng t·ªïng ti·ªÅn t·ª´ database
                const notesRow = document.createElement('tr');
                notesRow.innerHTML = `
           <td colspan="8" style="padding: 6px; text-align: left; font-style: italic;">
               <strong>Vi·∫øt b·∫±ng ch·ªØ: ${numberToWords(tongTienFromDB)}</strong>
           </td>
       `;
                tbody.appendChild(notesRow);

                // ƒê·ª£i t·∫•t c·∫£ h√¨nh ·∫£nh b·∫Øt ƒë·∫ßu load (kh√¥ng c·∫ßn ƒë·ª£i ho√†n th√†nh)
                await Promise.all(imageLoadPromises);
                console.log('All images started loading');

            } catch (error) {
                console.error('Error in populateProductTable:', error);
                throw error;
            }
        }

        // Show Error
        function showError(message) {
            const tbody = document.getElementById('productTableBody');
            tbody.innerHTML = `<tr><td colspan="8" class="error">‚ùå L·ªói: ${message}</td></tr>`;

            const fields = ['soPhieu', 'tenKhachHang', 'ngayLap', 'diaChiGiao', 'loaiKhachHang', 'nguoiNhanHang', 'soDienThoai', 'hanGiaoHang', 'nguoiDuyet', 'nguoiLapKy', 'ghichudonhang'];
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) element.textContent = 'L·ªói t·∫£i d·ªØ li·ªáu';
            });
        }

        // Get URL Parameter
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            // Ctrl+P for print
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                printDocument();
            }
        });

        // Print event listeners
        window.addEventListener('beforeprint', function () {
            console.log('Before print event triggered');
        });

        window.addEventListener('afterprint', function () {
            console.log('After print event triggered');
        });

        // Initialize - Modal and Document Ready
        document.addEventListener('DOMContentLoaded', function () {
            // Close modal when clicking X
            const closeBtn = document.querySelector('.close');
            if (closeBtn) {
                closeBtn.addEventListener('click', function () {
                    document.getElementById('imageModal').style.display = 'none';
                });
            }

            // Close modal when clicking outside image
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.addEventListener('click', function (e) {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            }

            // Initialize order data loading
            initializeOrderData();
        });

        // Initialize Order Data
        async function initializeOrderData() {
            try {
                const orderId = getUrlParameter('orderId');

                if (!orderId) {
                    throw new Error('Vui l√≤ng cung c·∫•p orderId trong URL (v√≠ d·ª•: ?orderId=ABC123)');
                }

                const orderData = await fetchOrderData(orderId);
                populateOrderHeader(orderData.header);
                await populateProductTable(orderData.details);

                // Enable print control after data is loaded
                document.getElementById('printBtn').disabled = false;

            } catch (error) {
                console.error('Error initializing order data:', error);
                showError(error.message);

                // Disable print control if data loading fails
                document.getElementById('printBtn').disabled = true;
            }
        }

        // Export functions for external use
        window.PrintManager = PrintManager;
        window.printDocument = printDocument;

        // Disable right-click and keyboard shortcuts for security
        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        }, false);

        document.onkeydown = function (e) {
            if (e.keyCode == 123) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
                return false;
            }
        };
    </script> -->
    
    <script src="https://mocan.gpems.net/donhang.js"></script>
</body>

</html>