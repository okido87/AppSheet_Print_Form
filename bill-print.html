<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Hóa đơn</title>
    <style>
        /* =================================================================== */
        /* 1. QUY TẮC IN VÀ KHỔ GIẤY (PRINT & PAGE RULES)                     */
        /* =================================================================== */
        @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            @page a4-portrait { size: A4 portrait; margin: 20mm; }
            @page a5-landscape { size: A5 landscape; margin: 15mm; }
            @page receipt-80mm { size: 80mm auto; margin: 0; }
            body.format-a4 { page: a4-portrait; }
            body.format-a5 { page: a5-landscape; }
            body.format-80mm { page: receipt-80mm; }
        }

        /* =================================================================== */
        /* 2. CSS CƠ BẢN (SHARED STYLES)                                      */
        /* =================================================================== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        .bill-container { background: white; color: #333; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .text-bold { font-weight: bold; }
        .error-message { color: red; font-size: 0.8em; padding: 10px; border: 1px dashed red; }
        .print-options { position: fixed; top: 10px; right: 10px; background: #f0f0f0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; z-index: 1000; }
        .print-options button { margin: 0 5px; padding: 5px 10px; cursor: pointer; }
        .company-name { font-weight: bold; }

        /* =================================================================== */
        /* 3. ĐỊNH DẠNG KHỔ 80MM (BIÊN LAI)                                   */
        /* =================================================================== */
        body.format-80mm {
            font-family: 'Courier New', monospace; font-size: 12px;
            width: 80mm; margin: 0 auto; padding: 5mm; color: #000;
        }
        .format-80mm .invoice-header, .format-80mm .customer-details, .format-80mm .products-table,
        .format-80mm .summary-section, .format-80mm .payment-section, .format-80mm .footer {
            width: 100%;
        }
        .format-80mm .company-header { text-align: center; margin-bottom: 0; border-bottom: 1px dashed #000; padding-bottom: 10px; }
        .format-80mm .company-name { font-size: 16px; }
        .format-80mm .company-info { font-size: 10px; line-height: 1.2; }
        .format-80mm .invoice-title-box { display: none; } /* Ẩn chữ HÓA ĐƠN to */
        .format-80mm .main-title-container { text-align: center; font-size: 16px; font-weight: bold; margin: 15px 0; }
        .format-80mm .customer-details-row { display: flex; justify-content: space-between; margin-bottom: 3px; }
        .format-80mm .products-table { font-size: 10px; }
        .format-80mm .products-table th, .format-80mm .products-table td { padding: 3px 2px; border-bottom: 1px solid #ddd; }
        .format-80mm .products-table th { border-bottom-width: 1px; border-color: #000; }
        .format-80mm .summary-section { margin-top: 15px; }
        .format-80mm .totals-box { border-top: 1px dashed #000; padding-top: 10px; width: 100%; }
        .format-80mm .total-row { display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 11px; }
        .format-80mm .total-final { font-weight: bold; font-size: 13px; border-top: 1px solid #000; padding-top: 5px; }
        .format-80mm .amount-in-words { font-size: 10px; font-style: italic; margin-top: 5px; text-align: center; }
        .format-80mm .payment-section { margin-top: 15px; border-top: 1px dashed #000; padding-top: 10px; text-align: center; }
        .format-80mm .qr-code img { width: 180px; height: 180px; }
        .format-80mm .footer { text-align: center; margin-top: 15px; font-size: 10px; border-top: 1px dashed #000; padding-top: 10px; }

        /* =================================================================== */
        /* 4. ĐỊNH DẠNG A4 & A5 (HÓA ĐƠN CHUYÊN NGHIỆP)                        */
        /* =================================================================== */
        body.format-a4, body.format-a5 {
            font-family: Arial, sans-serif;
            width: auto; padding: 0; margin: 0; background: #eee;
        }
        .format-a4 .bill-container, .format-a5 .bill-container {
            margin: 20px auto; box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .format-a4 .main-title-container, .format-a5 .main-title-container { display: none; }
        .format-a4 .invoice-header, .format-a5 .invoice-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; }
        .format-a4 .company-name, .format-a5 .company-name { font-size: 2em; color: #0056b3; }
        .format-a4 .invoice-title-box h2, .format-a5 .invoice-title-box h2 { font-size: 2.8em; color: #333; margin: 0; line-height: 1; text-align: right; }
        .format-a4 .invoice-title-box span, .format-a5 .invoice-title-box span { font-size: 1em; color: #777; text-align: right; display: block; }
        .format-a4 .customer-details, .format-a5 .customer-details { margin-bottom: 40px; padding: 15px; border: 1px solid #eee; border-radius: 5px; }
        .format-a4 .products-table, .format-a5 .products-table { border: 1px solid #ddd; border-radius: 5px; overflow: hidden; font-size: 0.9em; width: 100%; }
        .format-a4 .products-table thead tr, .format-a5 .products-table thead tr { background-color: #0056b3; color: white; }
        .format-a4 .products-table th, .format-a5 .products-table th { text-transform: uppercase; font-size: 0.85em; }
        .format-a4 .products-table tbody tr:nth-child(even), .format-a5 .products-table tbody tr:nth-child(even) { background-color: #f8f9fa; }
        .format-a4 .summary-section, .format-a5 .summary-section { display: flex; justify-content: flex-end; margin-top: 20px; }
        .format-a4 .totals-box, .format-a5 .totals-box { width: 50%; }
        .format-a4 .total-row, .format-a5 .total-row { border-bottom: 1px solid #eee; display: flex; justify-content: space-between;}
        .format-a4 .total-row span:first-child, .format-a5 .total-row span:first-child { color: #555; }
        .format-a4 .total-final, .format-a5 .total-final { display: flex; justify-content: space-between; background-color: #f8f9fa; }
        .format-a4 .total-final span, .format-a5 .total-final span { font-size: 1.2em; font-weight: bold; color: #0056b3; }
        .format-a4 .payment-section, .format-a5 .payment-section { display: flex; justify-content: space-between; align-items: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; }
        .format-a4 .footer, .format-a5 .footer { clear: both; margin-top: 40px; padding-top: 15px; border-top: 1px solid #ccc; font-size: 0.9em; color: #777; text-align: center; }

        /* --- A4 Specific Styles --- */
        body.format-a4 { font-size: 11pt; }
        .format-a4 .bill-container { max-width: 190mm; padding: 20mm; }
        .format-a4 .products-table th, .format-a4 .products-table td { padding: 12px 15px; }
        .format-a4 .qr-code img { width: 140px; height: 140px; }
        .format-a4 .total-row, .format-a4 .total-final { padding: 12px; }

        /* --- A5 Specific Styles --- */
        body.format-a5 { font-size: 9pt; }
        .format-a5 .bill-container { max-width: 180mm; padding: 15mm; }
        .format-a5 .products-table th, .format-a5 .products-table td { padding: 8px 10px; }
        .format-a5 .qr-code img { width: 110px; height: 110px; }
        .format-a5 .total-row, .format-a5 .total-final { padding: 8px; }

    </style>
</head>
<body>
    <div class="print-options no-print">
        <strong>Chọn khổ giấy:</strong>
        <button onclick="changeFormat('80mm')">80mm</button>
        <button onclick="changeFormat('a4')">A4</button>
        <button onclick="changeFormat('a5')">A5</button>
        <button onclick="window.print()">In Lại</button>
    </div>

    <div class="bill-container">
        <!-- Header -->
        <div class="invoice-header">
            <div class="company-details">
                <div class="company-name" id="ten_cong_ty"></div>
                <div class="company-info">
                    ĐC: <span id="dia_chi"></span><br>
                    ĐT: <span id="so_dien_thoai"></span> | Email: <span id="email"></span>
                </div>
            </div>
            <div class="invoice-title-box">
                <h2>HÓA ĐƠN</h2>
                <span>BÁN HÀNG</span>
            </div>
        </div>

        <!-- Tiêu đề này chỉ hiển thị trên khổ 80mm -->
        <div class="main-title-container">HÓA ĐƠN BÁN HÀNG</div>
        
        <!-- Customer Info -->
        <div class="customer-details">
            <div class="customer-details-row">
                <span class="text-bold">Số ĐH:</span> <span id="order-number"></span>
            </div>
            <div class="customer-details-row">
                 <span class="text-bold">Ngày đặt:</span> <span id="order-date"></span>
            </div>
            <div class="customer-details-row">
                <span class="text-bold">Khách hàng:</span> <span id="customer-name"></span>
            </div>
             <div class="customer-details-row">
                <span class="text-bold">In lúc:</span> <span id="print-time"></span>
            </div>
        </div>
        
        <!-- Products Table -->
        <table class="products-table">
            <thead><tr><th class="product-name">Sản phẩm</th><th class="text-center">SL</th><th class="text-right">Đơn giá</th><th class="text-right">Thành tiền</th></tr></thead>
            <tbody id="products-list"></tbody>
        </table>

        <!-- Summary & Totals -->
        <div class="summary-section">
            <div class="totals-box">
                <div class="total-row"><span>Thành tiền:</span><span id="subtotal" class="text-right"></span></div>
                <div class="total-row"><span>Giảm giá:</span><span id="discount" class="text-right"></span></div>
                <div class="total-row total-final">
                    <span class="text-bold">TỔNG CỘNG:</span>
                    <span id="total-amount" class="text-right text-bold"></span>
                </div>
                <div class="amount-in-words">
                    <span class="text-bold">Bằng chữ:</span> <span id="amount-words"></span>
                </div>
            </div>
        </div>
        
        <!-- Payment & QR Section -->
        <div class="payment-section">
             <div class="payment-details">
                <div class="text-bold">QUÉT MÃ QR ĐỂ THANH TOÁN</div>
             </div>
             <div class="qr-code" id="qr-code-container"></div>
             <div class="qr-info" style="display: none;">
                <span id="bank-name"></span> / <span id="account-number"></span> / <span id="account-holder"></span>
             </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div>Cảm ơn quý khách đã sử dụng dịch vụ!</div>
            <div>Hotline: <span id="footer_so_dien_thoai"></span> | Website: <span id="website"></span></div>
        </div>
    </div>
    
    <script>
        // JavaScript không có thay đổi
        function getUrlParameter(name) { const urlParams = new URLSearchParams(window.location.search); return urlParams.get(name) || ''; }
        function cleanNumberString(s) { if (typeof s !== 'string') return String(s); return s.replace(/,/g, ''); }
        function getBankCodeFromName(bankName) { if (!bankName) return null; const bankMap = { 'vietinbank': '970415', 'vcb': '970436', 'vietcombank': '970436', 'bidv': '970418', 'agribank': '970405', 'mbbank': '970422', 'mb': '970422', 'techcombank': '970407', 'tcb': '970407', 'acb': '970416', 'vpbank': '970432', 'tpbank': '970423' }; const formattedName = bankName.toLowerCase().replace(/\s/g, ''); return bankMap[formattedName] || null; }
        function formatCurrency(amount) { const cleanAmount = cleanNumberString(amount); if (cleanAmount === null || cleanAmount === '' || isNaN(cleanAmount)) return '0'; return parseInt(cleanAmount).toLocaleString('vi-VN'); }
        function formatDate(dateString) { if (!dateString) return new Date().toLocaleDateString('vi-VN'); try { const date = new Date(dateString); return isNaN(date) ? date.toLocaleDateString('vi-VN') : dateString; } catch (error) { return dateString; } }
        function numberToWords(numStr) { const num = parseInt(cleanNumberString(numStr), 10); if (isNaN(num) || num === null) return 'Không đồng'; if (num === 0) return 'Không đồng'; const ones = ['', 'một', 'hai', 'ba', 'bốn', 'năm', 'sáu', 'bảy', 'tám', 'chín'], tens = ['', 'mười', 'hai mươi', 'ba mươi', 'bốn mươi', 'năm mươi', 'sáu mươi', 'bảy mươi', 'tám mươi', 'chín mươi'], scales = ['', 'nghìn', 'triệu', 'tỷ']; function convertHundreds(n) { let result = '', h = Math.floor(n / 100), t = Math.floor((n % 100) / 10), o = n % 10; if (h > 0) result += ones[h] + ' trăm'; if (t > 0) { if (h > 0) result += ' '; if (t === 1) { result += 'mười'; if (o === 5) result += ' lăm'; else if (o > 0) result += ' ' + ones[o]; } else { result += tens[t]; if (o === 1) result += ' mốt'; else if (o === 5) result += ' lăm'; else if (o > 0) result += ' ' + ones[o]; } } else if (o > 0) { if (h > 0) result += ' linh '; result += ones[o]; } return result; } let result = '', scaleIndex = 0, n = num; while (n > 0) { const group = n % 1000; if (group > 0) result = convertHundreds(group) + (scales[scaleIndex] ? ' ' + scales[scaleIndex] : '') + (result ? ' ' + result : ''); n = Math.floor(n / 1000); scaleIndex++; } result = result.trim(); return result.charAt(0).toUpperCase() + result.slice(1) + ' đồng'; }
        function displayProducts(productsJson) { const tbody = document.getElementById('products-list'); tbody.innerHTML = ''; let products = []; try { if (productsJson) products = JSON.parse(decodeURIComponent(productsJson)); } catch (error) { tbody.innerHTML = '<tr><td colspan="4" class="text-center">Lỗi dữ liệu sản phẩm</td></tr>'; return; } if (!products || products.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center">Không có sản phẩm</td></tr>'; return; } products.forEach(p => { const row = document.createElement('tr'); row.innerHTML = `<td class="product-name">${p.sanpham||''}</td><td class="text-center">${p.soluong||0}</td><td class="text-right">${formatCurrency(p.dongia||0)}</td><td class="text-right">${formatCurrency(p.thanhtien||0)}</td>`; tbody.appendChild(row); }); }
        function generateVietQR(bankCode, accountNumber, amount, description, accountHolder) { return `https://img.vietqr.io/image/${bankCode}-${accountNumber}-compact2.png?amount=${amount}&addInfo=${encodeURIComponent(description)}&accountName=${encodeURIComponent(accountHolder)}`; }
        function updateQRCode(amount, orderNumber, bankCode, accountNumber, accountHolder) { const qrContainer = document.getElementById('qr-code-container'); if (!amount || !bankCode || !accountNumber || isNaN(parseInt(amount)) || parseInt(amount) <= 0) { qrContainer.innerHTML = '<div class="error-message">Lỗi: Dữ liệu thanh toán không hợp lệ.</div>'; return null; } const description = orderNumber || ''; const qrUrl = generateVietQR(bankCode, accountNumber, amount, description, accountHolder); const qrImage = new Image(); qrContainer.innerHTML = '<p>Đang tạo mã QR...</p>'; qrImage.onload = () => { qrContainer.innerHTML = ''; qrContainer.appendChild(qrImage); }; qrImage.onerror = () => { qrContainer.innerHTML = '<div class="error-message">Không thể tạo mã QR.</div>'; }; qrImage.src = qrUrl; return qrImage; }
        function autoPrint(qrImageElement) { const triggerPrint = () => setTimeout(() => window.print(), 500); if (!qrImageElement) { triggerPrint(); return; } if (qrImageElement.complete && qrImageElement.naturalHeight !== 0) triggerPrint(); else { qrImageElement.onload = triggerPrint; qrImageElement.onerror = triggerPrint; } }
        function loadDataFromUrl() { try { const orderNumber = getUrlParameter('so_don_hang'), orderDate = getUrlParameter('ngay_dat'), customerName = getUrlParameter('khach_hang'); const subtotal = getUrlParameter('thanh_tien'), discount = getUrlParameter('giam_gia'), totalAmount = getUrlParameter('tong_tien'); const productsJson = getUrlParameter('products'); const bankName = getUrlParameter('bank_name'), accountNumber = getUrlParameter('account_number'), accountHolder = getUrlParameter('account_holder'); const tenCongTy = getUrlParameter('ten_cong_ty'), diaChi = getUrlParameter('dia_chi'), soDienThoai = getUrlParameter('so_dien_thoai'), email = getUrlParameter('email'), websiteRaw = getUrlParameter('website'); let finalWebsite = websiteRaw; try { if (websiteRaw && websiteRaw.startsWith('{') && websiteRaw.endsWith('}')) { const websiteObj = JSON.parse(websiteRaw); finalWebsite = websiteObj.Url || websiteRaw; } } catch (e) { /* Bỏ qua lỗi parse */ } const bankCode = getBankCodeFromName(bankName), cleanTotalAmount = cleanNumberString(totalAmount); document.getElementById('ten_cong_ty').textContent = tenCongTy || 'Tên Công Ty'; document.getElementById('dia_chi').textContent = diaChi || 'N/A'; document.getElementById('so_dien_thoai').textContent = soDienThoai || 'N/A'; document.getElementById('email').textContent = email || 'N/A'; document.getElementById('footer_so_dien_thoai').textContent = soDienThoai || 'N/A'; document.getElementById('website').textContent = finalWebsite || 'N/A'; document.getElementById('order-number').textContent = orderNumber || 'N/A'; document.getElementById('order-date').textContent = formatDate(orderDate); document.getElementById('customer-name').textContent = customerName || 'Khách lẻ'; document.getElementById('print-time').textContent = new Date().toLocaleString('vi-VN'); document.getElementById('subtotal').textContent = formatCurrency(subtotal) + ' VNĐ'; document.getElementById('discount').textContent = formatCurrency(discount) + ' VNĐ'; document.getElementById('total-amount').textContent = formatCurrency(cleanTotalAmount) + ' VNĐ'; document.getElementById('amount-words').textContent = numberToWords(cleanTotalAmount); document.getElementById('bank-name').textContent = bankName || 'N/A'; document.getElementById('account-number').textContent = accountNumber || 'N/A'; document.getElementById('account-holder').textContent = accountHolder || 'N/A'; displayProducts(productsJson); const qrImageElement = updateQRCode(cleanTotalAmount, orderNumber, bankCode, accountNumber, accountHolder); autoPrint(qrImageElement); } catch (error) { console.error('Lỗi nghiêm trọng khi tải dữ liệu hóa đơn:', error); document.body.innerHTML = `<h1>Lỗi khi hiển thị hóa đơn</h1><p>${error.message}</p>`; } }
        function changeFormat(format) { document.body.classList.remove('format-80mm', 'format-a4', 'format-a5'); document.body.classList.add('format-' + format); }
        document.addEventListener('DOMContentLoaded', () => { const formatFromUrl = getUrlParameter('format'); const format = ['80mm', 'a4', 'a5'].includes(formatFromUrl) ? formatFromUrl : '80mm'; changeFormat(format); if (window.location.search.length > 1) { loadDataFromUrl(); } else { document.body.innerHTML = '<h1>Không có dữ liệu hóa đơn</h1><p>Vui lòng truy cập trang này thông qua AppSheet.</p>'; } });
    </script>
</body>
</html>
