<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- QUAN TRỌNG: Thẻ meta chống lưu cache trình duyệt -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <title>Hóa đơn - Michi Camp</title>
    <style>
        /* CSS cho khổ giấy in bill 80mm */
        @page {
            size: 80mm auto;
            margin: 0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.3;
            width: 80mm;
            margin: 0 auto;
            padding: 5mm;
            background: white;
            color: #000;
        }
        
        .bill-container {
            width: 100%;
            max-width: 70mm;
        }
        
        /* Header công ty */
        .company-header {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 1px dashed #000;
            padding-bottom: 10px;
        }
        
        .company-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .company-info {
            font-size: 10px;
            line-height: 1.2;
        }
        
        /* Thông tin đơn hàng */
        .order-info {
            margin-bottom: 15px;
            font-size: 11px;
        }
        
        .order-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        
        .order-info-label {
            font-weight: bold;
        }
        
        /* Bảng sản phẩm */
        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 10px;
        }
        
        .products-table th,
        .products-table td {
            padding: 3px 2px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .products-table th {
            font-weight: bold;
            border-bottom: 1px solid #000;
        }
        
        .product-name {
            max-width: 30mm;
            word-wrap: break-word;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        /* Tổng tiền */
        .total-section {
            border-top: 1px dashed #000;
            padding-top: 10px;
            margin-bottom: 15px;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 11px;
        }
        
        .total-final {
            font-weight: bold;
            font-size: 13px;
            border-top: 1px solid #000;
            padding-top: 5px;
        }
        
        .amount-in-words {
            font-size: 10px;
            font-style: italic;
            margin-top: 5px;
            text-align: center;
        }
        
        /* VietQR */
        .qr-section {
            text-align: center;
            margin-top: 15px;
            border-top: 1px dashed #000;
            padding-top: 10px;
        }
        
        .qr-code {
            margin: 10px 0;
            min-height: 200px; /* Đảm bảo không gian cho QR hoặc thông báo lỗi */
        }
        
        .qr-code img {
            width: 200px;
            height: 200px;
        }
        
        .qr-info {
            font-size: 9px;
            margin-top: 5px;
        }

        .error-message {
            color: red;
            font-size: 10px;
            padding: 10px;
            border: 1px dashed red;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            margin-top: 15px;
            font-size: 10px;
            border-top: 1px dashed #000;
            padding-top: 10px;
        }
        
        /* Print styles */
        @media print {
            body {
                margin: 0;
                padding: 2mm;
            }
            .bill-container {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="bill-container">
        <!-- Header công ty -->
        <div class="company-header">
            <div class="company-name">MICHI CAMP</div>
            <div class="company-info">
                ĐT: 038.578.7699 Email: info@michicam.vn<br>
            </div>
        </div>
        
        <!-- Tiêu đề hóa đơn -->
        <div style="text-align: center; font-size: 14px; font-weight: bold; margin-bottom: 15px;">
            HÓA ĐƠN BÁN HÀNG
        </div>
        
        <!-- Thông tin đơn hàng -->
        <div class="order-info">
            <div class="order-info-row">
                <span class="order-info-label">Số đơn hàng:</span>
                <span id="order-number"></span>
            </div>
            <div class="order-info-row">
                <span class="order-info-label">Ngày đặt:</span>
                <span id="order-date"></span>
            </div>
            <div class="order-info-row">
                <span class="order-info-label">Khách hàng:</span>
                <span id="customer-name"></span>
            </div>
            <div class="order-info-row">
                <span class="order-info-label">Ngày cập nhật:</span>
                <span id="update-date"></span>
            </div>
        </div>
        
        <!-- Bảng sản phẩm -->
        <table class="products-table">
            <thead>
                <tr>
                    <th class="product-name">Sản phẩm</th>
                    <th class="text-center">SL</th>
                    <th class="text-right">Đơn giá</th>
                    <th class="text-right">Thành tiền</th>
                </tr>
            </thead>
            <tbody id="products-list">
            </tbody>
        </table>
        
        <!-- Tổng tiền -->
        <div class="total-section">
            <div class="total-row">
                <span>Thành tiền:</span>
                <span id="subtotal"></span>
            </div>
            <div class="total-row">
                <span>Giảm giá:</span>
                <span id="discount"></span>
            </div>
            <div class="total-row total-final">
                <span>Tổng tiền:</span>
                <span id="total-amount"></span>
            </div>
            <div class="amount-in-words">
                Bằng chữ: <span id="amount-words"></span>
            </div>
        </div>
        
        <!-- VietQR -->
        <div class="qr-section">
            <div style="font-weight: bold; margin-bottom: 5px;">QUÉT MÃ ĐỂ THANH TOÁN</div>
            <div class="qr-code" id="qr-code-container">
                <!-- Sửa đổi: Bỏ ảnh placeholder, JS sẽ tạo ảnh hoặc thông báo lỗi -->
            </div>
             <!-- SỬA ĐỔI: Thêm các thẻ để hiển thị thông tin tài khoản -->
            <div class="qr-info">
                Ngân hàng: <span id="bank-name"></span><br>
                Số tài khoản: <span id="account-number"></span><br>
                Chủ tài khoản: <span id="account-holder"></span>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <div>Cảm ơn quý khách đã sử dụng dịch vụ!</div>
            <div style="margin-top: 5px; font-size: 9px;">
                Hotline: 038.578.7699 | Website: michicam.vn
            </div>
        </div>
    </div>
    
    <script>
        // --- CÁC HÀM TIỆN ÍCH ---

        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name) || '';
        }
        
        function formatCurrency(amount) {
            if (amount === null || amount === undefined || isNaN(amount)) return '0';
            return parseInt(amount).toLocaleString('vi-VN');
        }
        
        function formatDate(dateString) {
            if (!dateString) return new Date().toLocaleDateString('vi-VN');
            try {
                const date = new Date(dateString);
                if (isNaN(date)) return dateString; // Trả về chuỗi gốc nếu không phải ngày hợp lệ
                return date.toLocaleDateString('vi-VN');
            } catch (error) {
                return dateString;
            }
        }
        
        function numberToWords(num) {
            if (num === null || num === undefined || isNaN(num)) return 'Không đồng';
            num = Math.floor(num);
            if (num === 0) return 'Không đồng';
            
            const ones = ['', 'một', 'hai', 'ba', 'bốn', 'năm', 'sáu', 'bảy', 'tám', 'chín'];
            const tens = ['', 'mười', 'hai mươi', 'ba mươi', 'bốn mươi', 'năm mươi', 'sáu mươi', 'bảy mươi', 'tám mươi', 'chín mươi'];
            const scales = ['', 'nghìn', 'triệu', 'tỷ'];
            
            function convertHundreds(n) {
                let result = '';
                const hundreds = Math.floor(n / 100);
                const remainder = n % 100;
                const tensDigit = Math.floor(remainder / 10);
                const onesDigit = remainder % 10;
                
                if (hundreds > 0) {
                    result += ones[hundreds] + ' trăm';
                }
                
                if (tensDigit > 0) {
                    if (hundreds > 0 && tensDigit === 0 && onesDigit > 0) { result += ' linh '; }
                    else if (hundreds > 0 || (tensDigit > 0 && onesDigit > 0)) { result += ' '; }

                    if (tensDigit === 1) {
                        result += 'mười';
                        if (onesDigit === 5) { result += ' lăm'; }
                        else if (onesDigit > 0) { result += ' ' + ones[onesDigit]; }
                    } else {
                        result += tens[tensDigit];
                        if (onesDigit === 1) { result += ' mốt'; }
                        else if (onesDigit === 5) { result += ' lăm'; }
                        else if (onesDigit > 0) { result += ' ' + ones[onesDigit]; }
                    }
                } else if (onesDigit > 0) {
                    if (hundreds > 0) { result += ' linh '; }
                    result += ones[onesDigit];
                }
                return result;
            }
            
            let result = '';
            let scaleIndex = 0;
            while (num > 0) {
                const group = num % 1000;
                if (group > 0) {
                    result = convertHundreds(group) + (scales[scaleIndex] ? ' ' + scales[scaleIndex] : '') + (result ? ' ' + result : '');
                }
                num = Math.floor(num / 1000);
                scaleIndex++;
            }
            
            result = result.trim();
            return result.charAt(0).toUpperCase() + result.slice(1) + ' đồng';
        }

        // --- CÁC HÀM HIỂN THỊ DỮ LIỆU ---

        function displayProducts(productsJson) {
            const tbody = document.getElementById('products-list');
            tbody.innerHTML = '';
            let products = [];
            try {
                if(productsJson) products = JSON.parse(decodeURIComponent(productsJson));
            } catch (error) {
                console.error('Lỗi khi phân tích JSON sản phẩm:', error);
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">Lỗi dữ liệu sản phẩm</td></tr>';
                return;
            }
            
            if (!products || products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">Không có sản phẩm</td></tr>';
                return;
            }
            
            products.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="product-name">${p.sanpham || p.product_name || ''}</td>
                    <td class="text-center">${p.soluong || p.quantity || 0}</td>
                    <td class="text-right">${formatCurrency(p.dongia || p.unit_price || 0)}</td>
                    <td class="text-right">${formatCurrency(p.thanhtien || p.total_price || 0)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // --- HÀM TẠO VIETQR VÀ IN ẤN (ĐÃ CẢI TIẾN) ---

        function generateVietQR(bankCode, accountNumber, amount, description, accountHolder) {
            return `https://img.vietqr.io/image/${bankCode}-${accountNumber}-compact2.png?amount=${amount}&addInfo=${encodeURIComponent(description)}&accountName=${encodeURIComponent(accountHolder)}`;
        }

        function updateQRCode(amount, orderNumber, bankCode, accountNumber, accountHolder) {
            const qrContainer = document.getElementById('qr-code-container');
            qrContainer.innerHTML = ''; // Xóa nội dung cũ

            // 1. Kiểm tra dữ liệu đầu vào
            if (!amount || !bankCode || !accountNumber || isNaN(parseInt(amount)) || parseInt(amount) <= 0) {
                qrContainer.innerHTML = '<div class="error-message">Lỗi: Dữ liệu thanh toán không hợp lệ để tạo mã QR.</div>';
                return null; // Trả về null để hàm autoPrint biết là có lỗi
            }
            
            // 2. Tạo ảnh và thêm sự kiện xử lý
            const description = `TT HD ${orderNumber || ''}`.trim();
            const qrUrl = generateVietQR(bankCode, accountNumber, amount, description, accountHolder);
            
            // Dòng này cực kỳ hữu ích để bạn kiểm tra URL đã đúng chưa
            console.log("URL VietQR được tạo:", qrUrl); 

            const qrImage = new Image();
            qrImage.width = 200;
            qrImage.height = 200;

            // Hiển thị thông báo đang tải
            qrContainer.innerHTML = '<p>Đang tạo mã QR...</p>';

            qrImage.onload = function() {
                // Tải thành công: thay thế thông báo bằng ảnh QR
                qrContainer.innerHTML = '';
                qrContainer.appendChild(qrImage);
            };

            qrImage.onerror = function() {
                // Tải thất bại: hiển thị thông báo lỗi
                console.error("Không thể tải ảnh VietQR. API có thể lỗi hoặc dữ liệu không đúng.");
                qrContainer.innerHTML = '<div class="error-message">Không thể tạo mã QR.<br>Vui lòng kiểm tra lại thông tin hoặc thử lại sau.</div>';
            };

            // 3. Gán src để bắt đầu tải ảnh
            qrImage.src = qrUrl;
            return qrImage; // Trả về đối tượng ảnh để hàm autoPrint theo dõi
        }
        
        function autoPrint(qrImageElement) {
            const autoPrintParam = getUrlParameter('auto_print');
            if (autoPrintParam !== 'true' && autoPrintParam !== '1') {
                return;
            }
            
            // Nếu qrImageElement là null (do lỗi dữ liệu), vẫn in sau một lúc
            if (!qrImageElement) {
                setTimeout(() => window.print(), 1000);
                return;
            }

            const triggerPrint = () => {
                // Đợi một chút để trình duyệt render xong ảnh/thông báo lỗi
                setTimeout(() => window.print(), 500); 
            };
            
            if (qrImageElement.complete && qrImageElement.naturalHeight !== 0) {
                triggerPrint();
            } else {
                qrImageElement.onload = triggerPrint;
                qrImageElement.onerror = triggerPrint; // Vẫn in dù QR lỗi
            }
        }

        // --- HÀM CHÍNH ĐỂ TẢI DỮ LIỆU ---

        function loadDataFromUrl() {
            try {
                // Thông tin đơn hàng
                const orderNumber = getUrlParameter('so_don_hang');
                const orderDate = getUrlParameter('ngay_dat');
                const customerName = getUrlParameter('khach_hang');
                const updateDate = getUrlParameter('ngay_cap_nhat');
                const subtotal = getUrlParameter('thanh_tien');
                const discount = getUrlParameter('giam_gia');
                const totalAmount = getUrlParameter('tong_tien');
                
                document.getElementById('order-number').textContent = orderNumber || 'N/A';
                document.getElementById('order-date').textContent = formatDate(orderDate);
                document.getElementById('customer-name').textContent = customerName || 'Khách lẻ';
                document.getElementById('update-date').textContent = formatDate(updateDate || new Date());
                
                // Tổng tiền
                document.getElementById('subtotal').textContent = formatCurrency(subtotal) + ' VNĐ';
                document.getElementById('discount').textContent = formatCurrency(discount) + ' VNĐ';
                document.getElementById('total-amount').textContent = formatCurrency(totalAmount) + ' VNĐ';
                document.getElementById('amount-words').textContent = numberToWords(totalAmount);
                
                // Sản phẩm
                displayProducts(getUrlParameter('products'));
                
                // Thông tin ngân hàng cho VietQR
                const bankCode = getUrlParameter('bank_code');
                const bankName = getUrlParameter('bank_name');
                const accountNumber = getUrlParameter('account_number');
                const accountHolder = getUrlParameter('account_holder');
                
                document.getElementById('bank-name').textContent = bankName || 'N/A';
                document.getElementById('account-number').textContent = accountNumber || 'N/A';
                document.getElementById('account-holder').textContent = accountHolder || 'N/A';
                
                // Tạo VietQR và chuẩn bị để in
                const qrImageElement = updateQRCode(totalAmount, orderNumber, bankCode, accountNumber, accountHolder);
                autoPrint(qrImageElement);
                
            } catch (error) {
                console.error('Lỗi nghiêm trọng khi tải dữ liệu hóa đơn:', error);
                document.body.innerHTML = `<h1>Lỗi tải dữ liệu hóa đơn</h1><p>${error.message}</p>`;
            }
        }
        
        // --- ĐIỂM BẮT ĐẦU THỰC THI ---

        document.addEventListener('DOMContentLoaded', function() {
            if (window.location.search.length > 1) { // Chỉ chạy khi có tham số trên URL
                 loadDataFromUrl();
            } else {
                document.body.innerHTML = '<h1>Không có dữ liệu hóa đơn</h1><p>Vui lòng truy cập trang này thông qua AppSheet hoặc cung cấp tham số trên URL.</p>';
            }
        });
    </script>
</body>
</html>
