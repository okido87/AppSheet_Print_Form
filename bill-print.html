<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Hóa đơn - Michi Camp</title>
    <style>
        @page { size: 80mm auto; margin: 0; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.3; width: 80mm; margin: 0 auto; padding: 5mm; background: white; color: #000; }
        .bill-container { width: 100%; max-width: 70mm; }
        .company-header { text-align: center; margin-bottom: 15px; border-bottom: 1px dashed #000; padding-bottom: 10px; }
        .company-name { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
        .company-info { font-size: 10px; line-height: 1.2; }
        .order-info { margin-bottom: 15px; font-size: 11px; }
        .order-info-row { display: flex; justify-content: space-between; margin-bottom: 3px; }
        .order-info-label { font-weight: bold; }
        .products-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 10px; }
        .products-table th, .products-table td { padding: 3px 2px; text-align: left; border-bottom: 1px solid #ddd; }
        .products-table th { font-weight: bold; border-bottom: 1px solid #000; }
        .product-name { max-width: 30mm; word-wrap: break-word; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .total-section { border-top: 1px dashed #000; padding-top: 10px; margin-bottom: 15px; }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 11px; }
        .total-final { font-weight: bold; font-size: 13px; border-top: 1px solid #000; padding-top: 5px; }
        .amount-in-words { font-size: 10px; font-style: italic; margin-top: 5px; text-align: center; }
        .qr-section { text-align: center; margin-top: 15px; border-top: 1px dashed #000; padding-top: 10px; }
        .qr-code { margin: 10px 0; min-height: 200px; display: flex; align-items: center; justify-content: center; }
        .qr-code img { width: 200px; height: 200px; }
        .qr-info { font-size: 9px; margin-top: 5px; line-height: 1.4; }
        .error-message { color: red; font-size: 10px; padding: 10px; border: 1px dashed red; }
        .footer { text-align: center; margin-top: 15px; font-size: 10px; border-top: 1px dashed #000; padding-top: 10px; }
        @media print { body { margin: 0; padding: 2mm; } .bill-container { page-break-inside: avoid; } }
    </style>
</head>
<body>
    <div class="bill-container">
        <!-- Header -->
        <div class="company-header">
            <div class="company-name">MICHI CAMP</div>
            <div class="company-info">
                ĐC: Thôn Tân Lai, Xã Hữu Liên, Tỉnh Lạng Sơn<br>
                ĐT: 038.578.7699 Email: info@michicam.vn<br>
            </div>
        </div>
        <div style="text-align: center; font-size: 14px; font-weight: bold; margin-bottom: 15px;">HÓA ĐƠN BÁN HÀNG</div>
        
        <!-- Order Info -->
        <div class="order-info">
            <div class="order-info-row"><span class="order-info-label">Số đơn hàng:</span><span id="order-number"></span></div>
            <div class="order-info-row"><span class="order-info-label">Ngày đặt:</span><span id="order-date"></span></div>
            <div class="order-info-row"><span class="order-info-label">Khách hàng:</span><span id="customer-name"></span></div>
            <div class="order-info-row"><span class="order-info-label">Ngày cập nhật:</span><span id="update-date"></span></div>
        </div>
        
        <!-- Products Table -->
        <table class="products-table">
            <thead><tr><th class="product-name">Sản phẩm</th><th class="text-center">SL</th><th class="text-right">Đơn giá</th><th class="text-right">Thành tiền</th></tr></thead>
            <tbody id="products-list"></tbody>
        </table>
        
        <!-- Totals -->
        <div class="total-section">
            <div class="total-row"><span>Thành tiền:</span><span id="subtotal"></span></div>
            <div class="total-row"><span>Giảm giá:</span><span id="discount"></span></div>
            <div class="total-row total-final"><span>Tổng tiền:</span><span id="total-amount"></span></div>
            <div class="amount-in-words">Bằng chữ: <span id="amount-words"></span></div>
        </div>
        
        <!-- VietQR Section -->
        <div class="qr-section">
            <div style="font-weight: bold; margin-bottom: 5px;">QUÉT MÃ ĐỂ THANH TOÁN</div>
            <div class="qr-code" id="qr-code-container"></div>
<!--             <div class="qr-info">
<!--                 Ngân hàng: <span id="bank-name"></span><br>
<!--                 Số tài khoản: <span id="account-number"></span><br> -->
<!--                 Chủ tài khoản: <span id="account-holder"></span> --> -->
<!--             </div> --> -->
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <div>Cảm ơn quý khách đã sử dụng dịch vụ!</div>
            <div style="margin-top: 5px; font-size: 9px;">Hotline: 038.578.7699 | Website: michicam.vn</div>
        </div>
    </div>
    
    <script>
        // --- CÁC HÀM TIỆN ÍCH ---
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name) || '';
        }
        
        function cleanNumberString(s) {
            if (typeof s !== 'string') return s;
            return s.replace(/,/g, '');
        }

        function formatCurrency(amount) {
            const cleanAmount = cleanNumberString(String(amount));
            if (cleanAmount === null || cleanAmount === '' || isNaN(cleanAmount)) return '0';
            return parseInt(cleanAmount).toLocaleString('vi-VN');
        }

        function formatDate(dateString) {
            if (!dateString) return new Date().toLocaleDateString('vi-VN');
            try {
                const date = new Date(dateString);
                return isNaN(date) ? dateString : date.toLocaleDateString('vi-VN');
            } catch (error) { return dateString; }
        }
        
        function numberToWords(numStr) {
            const num = parseInt(cleanNumberString(String(numStr)), 10);
            if (isNaN(num) || num === null) return 'Không đồng';
            if (num === 0) return 'Không đồng';
            const ones = ['', 'một', 'hai', 'ba', 'bốn', 'năm', 'sáu', 'bảy', 'tám', 'chín'];
            const tens = ['', 'mười', 'hai mươi', 'ba mươi', 'bốn mươi', 'năm mươi', 'sáu mươi', 'bảy mươi', 'tám mươi', 'chín mươi'];
            const scales = ['', 'nghìn', 'triệu', 'tỷ'];
            function convertHundreds(n) {
                let result = '';
                const h = Math.floor(n / 100), t = Math.floor((n % 100) / 10), o = n % 10;
                if (h > 0) result += ones[h] + ' trăm';
                if (t > 0) {
                    if (h > 0) result += ' ';
                    if (t === 1) { result += 'mười'; if (o === 5) result += ' lăm'; else if (o > 0) result += ' ' + ones[o]; } 
                    else { result += tens[t]; if (o === 1) result += ' mốt'; else if (o === 5) result += ' lăm'; else if (o > 0) result += ' ' + ones[o]; }
                } else if (o > 0) { if (h > 0) result += ' linh '; result += ones[o]; }
                return result;
            }
            let result = '', scaleIndex = 0, n = num;
            while (n > 0) {
                const group = n % 1000;
                if (group > 0) { result = convertHundreds(group) + (scales[scaleIndex] ? ' ' + scales[scaleIndex] : '') + (result ? ' ' + result : ''); }
                n = Math.floor(n / 1000); scaleIndex++;
            }
            result = result.trim();
            return result.charAt(0).toUpperCase() + result.slice(1) + ' đồng';
        }

        // --- CÁC HÀM HIỂN THỊ DỮ LIỆU ---
        function displayProducts(productsJson) {
            const tbody = document.getElementById('products-list');
            tbody.innerHTML = ''; let products = [];
            try { if (productsJson) products = JSON.parse(decodeURIComponent(productsJson)); }
            catch (error) { tbody.innerHTML = '<tr><td colspan="4" class="text-center">Lỗi dữ liệu sản phẩm</td></tr>'; return; }
            if (!products || products.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center">Không có sản phẩm</td></tr>'; return; }
            products.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="product-name">${p.sanpham||''}</td><td class="text-center">${p.soluong||0}</td><td class="text-right">${formatCurrency(p.dongia||0)}</td><td class="text-right">${formatCurrency(p.thanhtien||0)}</td>`;
                tbody.appendChild(row);
            });
        }

        // --- HÀM TẠO VIETQR VÀ IN ẤN ---
        function generateVietQR(bankCode, accountNumber, amount, description, accountHolder) {
            return `https://img.vietqr.io/image/${bankCode}-${accountNumber}-compact2.png?amount=${amount}&addInfo=${encodeURIComponent(description)}&accountName=${encodeURIComponent(accountHolder)}`;
        }

        function updateQRCode(amount, orderNumber, bankCode, accountNumber, accountHolder) {
            const qrContainer = document.getElementById('qr-code-container');
            if (!amount || !bankCode || !accountNumber || isNaN(parseInt(amount)) || parseInt(amount) <= 0) {
                qrContainer.innerHTML = '<div class="error-message">Lỗi: Dữ liệu thanh toán không hợp lệ để tạo mã QR.</div>';
                return null;
            }
            const description = orderNumber || '';
            const qrUrl = generateVietQR(bankCode, accountNumber, amount, description, accountHolder);
            const qrImage = new Image(200, 200);
            qrContainer.innerHTML = '<p>Đang tạo mã QR...</p>';
            qrImage.onload = () => { qrContainer.innerHTML = ''; qrContainer.appendChild(qrImage); };
            qrImage.onerror = () => { qrContainer.innerHTML = '<div class="error-message">Không thể tạo mã QR.<br>Vui lòng thử lại sau.</div>'; };
            qrImage.src = qrUrl;
            return qrImage;
        }
        
        function autoPrint(qrImageElement) {
            const autoPrintParam = getUrlParameter('auto_print');
            if (autoPrintParam !== 'true' && autoPrintParam !== '1') return;
            const triggerPrint = () => setTimeout(() => window.print(), 500);
            if (!qrImageElement) { triggerPrint(); return; }
            if (qrImageElement.complete && qrImageElement.naturalHeight !== 0) triggerPrint();
            else { qrImageElement.onload = triggerPrint; qrImageElement.onerror = triggerPrint; }
        }

        // --- HÀM CHÍNH ĐỂ TẢI DỮ LIỆU ---
        function loadDataFromUrl() {
            try {
                // Đọc tất cả tham số từ URL
                const orderNumber = getUrlParameter('so_don_hang');
                const orderDate = getUrlParameter('ngay_dat');
                const customerName = getUrlParameter('khach_hang');
                const updateDate = getUrlParameter('ngay_cap_nhat');
                const subtotal = getUrlParameter('thanh_tien');
                const discount = getUrlParameter('giam_gia');
                const totalAmount = getUrlParameter('tong_tien');
                const bankCode = getUrlParameter('bank_code');
                const bankName = getUrlParameter('bank_name');
                const accountNumber = getUrlParameter('account_number');
                const accountHolder = getUrlParameter('account_holder');
                const productsJson = getUrlParameter('products');

                // Dọn dẹp dữ liệu số
                const cleanTotalAmount = cleanNumberString(totalAmount);

                // Điền dữ liệu vào các thẻ HTML tương ứng
                document.getElementById('order-number').textContent = orderNumber || 'N/A';
                document.getElementById('order-date').textContent = formatDate(orderDate);
                document.getElementById('customer-name').textContent = customerName || 'Khách lẻ';
                document.getElementById('update-date').textContent = formatDate(updateDate || new Date());
                document.getElementById('subtotal').textContent = formatCurrency(subtotal) + ' VNĐ';
                document.getElementById('discount').textContent = formatCurrency(discount) + ' VNĐ';
                document.getElementById('total-amount').textContent = formatCurrency(cleanTotalAmount) + ' VNĐ';
                document.getElementById('amount-words').textContent = numberToWords(cleanTotalAmount);
                document.getElementById('bank-name').textContent = bankName || 'VIETTINBANK';
                document.getElementById('account-number').textContent = accountNumber || '102893157888';
                document.getElementById('account-holder').textContent = accountHolder || 'PHAM DUC HUY';
                
                displayProducts(productsJson);
                
                const qrImageElement = updateQRCode(cleanTotalAmount, orderNumber, bankCode, accountNumber, accountHolder);
                autoPrint(qrImageElement);
                
            } catch (error) {
                console.error('Lỗi nghiêm trọng khi tải dữ liệu hóa đơn:', error);
                document.body.innerHTML = `<h1>Lỗi khi hiển thị hóa đơn</h1><p>${error.message}</p>`;
            }
        }
        
        // --- ĐIỂM BẮT ĐẦU THỰC THI ---
        document.addEventListener('DOMContentLoaded', () => {
            if (window.location.search.length > 1) {
                 loadDataFromUrl();
            } else {
                document.body.innerHTML = '<h1>Không có dữ liệu hóa đơn</h1><p>Vui lòng truy cập trang này thông qua AppSheet.</p>';
            }
        });
    </script>
</body>
</html>
