<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hóa đơn - EMS Solution</title>
    <style>
        /* CSS cho khổ giấy in bill 80mm */
        @page {
            size: 80mm auto;
            margin: 0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.3;
            width: 80mm;
            margin: 0 auto;
            padding: 5mm;
            background: white;
            color: #000;
        }
        
        .bill-container {
            width: 100%;
            max-width: 70mm;
        }
        
        /* Header công ty */
        .company-header {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 1px dashed #000;
            padding-bottom: 10px;
        }
        
        .company-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .company-info {
            font-size: 10px;
            line-height: 1.2;
        }
        
        /* Thông tin đơn hàng */
        .order-info {
            margin-bottom: 15px;
            font-size: 11px;
        }
        
        .order-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        
        .order-info-label {
            font-weight: bold;
        }
        
        /* Bảng sản phẩm */
        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 10px;
        }
        
        .products-table th,
        .products-table td {
            padding: 3px 2px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .products-table th {
            font-weight: bold;
            border-bottom: 1px solid #000;
        }
        
        .product-name {
            max-width: 30mm;
            word-wrap: break-word;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        /* Tổng tiền */
        .total-section {
            border-top: 1px dashed #000;
            padding-top: 10px;
            margin-bottom: 15px;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 11px;
        }
        
        .total-final {
            font-weight: bold;
            font-size: 13px;
            border-top: 1px solid #000;
            padding-top: 5px;
        }
        
        .amount-in-words {
            font-size: 10px;
            font-style: italic;
            margin-top: 5px;
            text-align: center;
        }
        
        /* VietQR */
        .qr-section {
            text-align: center;
            margin-top: 15px;
            border-top: 1px dashed #000;
            padding-top: 10px;
        }
        
        .qr-code {
            margin: 10px 0;
        }
        
        .qr-code img {
            width: 100px;
            height: 100px;
        }
        
        .qr-info {
            font-size: 9px;
            margin-top: 5px;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            margin-top: 15px;
            font-size: 10px;
            border-top: 1px dashed #000;
            padding-top: 10px;
        }
        
        /* Print styles */
        @media print {
            body {
                margin: 0;
                padding: 2mm;
            }
            
            .bill-container {
                page-break-inside: avoid;
            }
            
            .no-print {
                display: none;
            }
        }
        
        /* Responsive cho mobile */
        @media screen and (max-width: 480px) {
            body {
                width: 100%;
                max-width: 100%;
                padding: 10px;
            }
            
            .bill-container {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="bill-container">
        <!-- Header công ty -->
        <div class="company-header">
            <div class="company-name">MICHI CAM</div>
            <div class="company-info">
                Địa chỉ: Thôn Tân Lai, Xã Hữu Liên, Tỉnh Lạng Sơn<br>
                Điện thoại: 038.578.7699 Email: info@michicam.vn
            </div>
        </div>
        
        <!-- Tiêu đề hóa đơn -->
        <div style="text-align: center; font-size: 14px; font-weight: bold; margin-bottom: 15px;">
            HÓA ĐƠN BÁN HÀNG
        </div>
        
        <!-- Thông tin đơn hàng -->
        <div class="order-info">
            <div class="order-info-row">
                <span class="order-info-label">Số đơn hàng:</span>
                <span id="order-number">DH001</span>
            </div>
            <div class="order-info-row">
                <span class="order-info-label">Ngày đặt:</span>
                <span id="order-date">01/01/2024</span>
            </div>
            <div class="order-info-row">
                <span class="order-info-label">Khách hàng:</span>
                <span id="customer-name">Nguyễn Văn A</span>
            </div>
            <div class="order-info-row">
                <span class="order-info-label">Ngày cập nhật:</span>
                <span id="update-date">01/01/2024</span>
            </div>
        </div>
        
        <!-- Bảng sản phẩm -->
        <table class="products-table">
            <thead>
                <tr>
                    <th class="product-name">Sản phẩm</th>
                    <th class="text-center">SL</th>
                    <th class="text-right">Đơn giá</th>
                    <th class="text-right">Thành tiền</th>
                </tr>
            </thead>
            <tbody id="products-list">
                <!-- Sản phẩm sẽ được thêm bằng JavaScript -->
                <tr>
                    <td class="product-name">Sản phẩm mẫu</td>
                    <td class="text-center">1</td>
                    <td class="text-right">100,000</td>
                    <td class="text-right">100,000</td>
                </tr>
            </tbody>
        </table>
        
        <!-- Tổng tiền -->
        <div class="total-section">
            <div class="total-row">
                <span>Thành tiền:</span>
                <span id="subtotal">100,000 VNĐ</span>
            </div>
            <div class="total-row">
                <span>Giảm giá:</span>
                <span id="discount">0 VNĐ</span>
            </div>
            <div class="total-row total-final">
                <span>Tổng tiền:</span>
                <span id="total-amount">100,000 VNĐ</span>
            </div>
            <div class="amount-in-words">
                Bằng chữ: <span id="amount-words">Một trăm nghìn đồng</span>
            </div>
        </div>
        
        <!-- VietQR -->
        <div class="qr-section">
            <div style="font-weight: bold; margin-bottom: 5px;">THANH TOÁN QUA QR CODE</div>
            <div class="qr-code">
                <img id="qr-image" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2Y5ZjlmOSIgc3Ryb2tlPSIjY2NjIiBzdHJva2Utd2lkdGg9IjEiLz4KICA8dGV4dCB4PSI1MCIgeT0iNTUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzY2NiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+UVIgQ29kZTwvdGV4dD4KPC9zdmc+" alt="QR Code">
            </div>
            <div class="qr-info">
                Ngân hàng: <span id="bank-name">VietinBank</span><br>
                STK: <span id="account-number">102893157888</span><br>
                Chủ TK: <span id="account-holder">PHAM DUC HUY</span>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <div>Cảm ơn quý khách đã sử dụng dịch vụ!</div>
            <div style="margin-top: 5px; font-size: 9px;">
                Hotline: 038.578.7699 | Website: michicam.vn
            </div>
        </div>
    </div>
    
    <!-- Thêm thư viện QR Code -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <!-- JavaScript xử lý dữ liệu từ URL -->
    <script>
        // Hàm đọc tham số từ URL
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name) || '';
        }
        
        // Hàm format số tiền
        function formatCurrency(amount) {
            if (!amount || isNaN(amount)) return '0';
            return parseInt(amount).toLocaleString('vi-VN');
        }
        
        // Hàm chuyển số thành chữ tiếng Việt
        function numberToWords(num) {
            if (num === 0) return 'không đồng';
            
            const ones = ['', 'một', 'hai', 'ba', 'bốn', 'năm', 'sáu', 'bảy', 'tám', 'chín'];
            const tens = ['', '', 'hai mươi', 'ba mươi', 'bốn mươi', 'năm mươi', 'sáu mươi', 'bảy mươi', 'tám mươi', 'chín mươi'];
            const scales = ['', 'nghìn', 'triệu', 'tỷ'];
            
            function convertHundreds(n) {
                let result = '';
                
                const hundreds = Math.floor(n / 100);
                const remainder = n % 100;
                const tensDigit = Math.floor(remainder / 10);
                const onesDigit = remainder % 10;
                
                if (hundreds > 0) {
                    result += ones[hundreds] + ' trăm';
                    if (remainder > 0) result += ' ';
                }
                
                if (tensDigit > 1) {
                    result += tens[tensDigit];
                    if (onesDigit > 0) {
                        if (onesDigit === 1) {
                            result += ' một';
                        } else if (onesDigit === 5 && tensDigit > 1) {
                            result += ' lăm';
                        } else {
                            result += ' ' + ones[onesDigit];
                        }
                    }
                } else if (tensDigit === 1) {
                    if (onesDigit === 0) {
                        result += 'mười';
                    } else if (onesDigit === 5) {
                        result += 'mười lăm';
                    } else {
                        result += 'mười ' + ones[onesDigit];
                    }
                } else if (onesDigit > 0) {
                    if (hundreds > 0) {
                        result += 'lẻ ' + ones[onesDigit];
                    } else {
                        result += ones[onesDigit];
                    }
                }
                
                return result.trim();
            }
            
            function convertNumber(n) {
                if (n === 0) return '';
                
                let result = '';
                let scaleIndex = 0;
                
                while (n > 0) {
                    const group = n % 1000;
                    if (group > 0) {
                        let groupText = convertHundreds(group);
                        if (scaleIndex > 0) {
                            groupText += ' ' + scales[scaleIndex];
                        }
                        result = groupText + (result ? ' ' + result : '');
                    }
                    n = Math.floor(n / 1000);
                    scaleIndex++;
                }
                
                return result;
            }
            
            const result = convertNumber(Math.floor(num));
            return result.charAt(0).toUpperCase() + result.slice(1) + ' đồng';
        }
        
        // Hàm tạo VietQR
        function generateVietQR(bankCode, accountNumber, amount, description, accountHolder) {
            // Format VietQR theo chuẩn
            const qrData = {
                bankCode: bankCode || '970415', // Mã ngân hàng VietinBank
                accountNumber: accountNumber || '102893157888',
                amount: amount || 0,
                description: description || 'Thanh toan hoa don',
                accountHolder: accountHolder || 'PHAM DUC HUY'
            };
            
            // Tạo URL VietQR
            const vietqrUrl = `https://img.vietqr.io/image/${qrData.bankCode}-${qrData.accountNumber}-compact2.png?amount=${qrData.amount}&addInfo=${encodeURIComponent(qrData.description)}&accountName=${encodeURIComponent(qrData.accountHolder)}`;
            
            return vietqrUrl;
        }
        
        // Hàm cập nhật QR code
        function updateQRCode(amount, orderNumber, bankCode, accountNumber, accountHolder) {
            const description = `Thanh toan don hang ${orderNumber || 'DH001'}`;
            const qrUrl = generateVietQR(bankCode, accountNumber, amount, description, accountHolder);
            
            const qrImage = document.getElementById('qr-image');
            qrImage.src = qrUrl;
            qrImage.alt = 'VietQR Code';
        }
        
        // Hàm parse dữ liệu sản phẩm từ JSON string
        function parseProducts(productsJson) {
            try {
                if (!productsJson) return [];
                // Nếu là string JSON, parse nó
                if (typeof productsJson === 'string') {
                    return JSON.parse(decodeURIComponent(productsJson));
                }
                return productsJson;
            } catch (error) {
                console.error('Error parsing products:', error);
                return [];
            }
        }
        
        // Hàm hiển thị danh sách sản phẩm
        function displayProducts(products) {
            const tbody = document.getElementById('products-list');
            tbody.innerHTML = '';
            
            if (!products || products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">Không có sản phẩm</td></tr>';
                return;
            }
            
            products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="product-name">${product.sanpham || product.product_name || ''}</td>
                    <td class="text-center">${product.soluong || product.quantity || 0}</td>
                    <td class="text-right">${formatCurrency(product.dongia || product.unit_price || 0)}</td>
                    <td class="text-right">${formatCurrency(product.thanhtien || product.total_price || 0)}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Hàm format ngày
        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('vi-VN');
            } catch (error) {
                return dateString;
            }
        }
        
        // Hàm load dữ liệu từ URL parameters
        function loadDataFromUrl() {
            try {
                // Thông tin đơn hàng từ bảng DonHang
                const orderNumber = getUrlParameter('so_don_hang') || getUrlParameter('order_number');
                const orderDate = getUrlParameter('ngay_dat') || getUrlParameter('order_date');
                const customerName = getUrlParameter('khach_hang') || getUrlParameter('customer_name');
                const updateDate = getUrlParameter('ngay_cap_nhat') || getUrlParameter('update_date');
                const subtotal = getUrlParameter('thanh_tien') || getUrlParameter('subtotal');
                const discount = getUrlParameter('giam_gia') || getUrlParameter('discount');
                const totalAmount = getUrlParameter('tong_tien') || getUrlParameter('total_amount');
                
                // Cập nhật thông tin đơn hàng
                if (orderNumber) document.getElementById('order-number').textContent = orderNumber;
                if (orderDate) document.getElementById('order-date').textContent = formatDate(orderDate);
                if (customerName) document.getElementById('customer-name').textContent = customerName;
                if (updateDate) document.getElementById('update-date').textContent = formatDate(updateDate);
                
                // Cập nhật tổng tiền
                if (subtotal) document.getElementById('subtotal').textContent = formatCurrency(subtotal) + ' VNĐ';
                if (discount) document.getElementById('discount').textContent = formatCurrency(discount) + ' VNĐ';
                if (totalAmount) {
                    document.getElementById('total-amount').textContent = formatCurrency(totalAmount) + ' VNĐ';
                    // Cập nhật số tiền bằng chữ
                    document.getElementById('amount-words').textContent = numberToWords(parseInt(totalAmount));
                }
                
                // Dữ liệu sản phẩm từ bảng CTDonHang
                const productsData = getUrlParameter('products') || getUrlParameter('san_pham');
                const products = parseProducts(productsData);
                displayProducts(products);
                
                // Thông tin ngân hàng cho VietQR
                const bankCode = getUrlParameter('bank_code') || '970415';
                const bankName = getUrlParameter('bank_name') || 'VietinBank';
                const accountNumber = getUrlParameter('account_number') || '102893157888';
                const accountHolder = getUrlParameter('account_holder') || 'PHAM DUC HUY';
                
                if (bankName) document.getElementById('bank-name').textContent = bankName;
                if (accountNumber) document.getElementById('account-number').textContent = accountNumber;
                if (accountHolder) document.getElementById('account-holder').textContent = accountHolder;
                
                // Tạo VietQR
                if (totalAmount) {
                    updateQRCode(totalAmount, orderNumber, bankCode, accountNumber, accountHolder);
                }
                
                console.log('Data loaded successfully');
                
            } catch (error) {
                console.error('Error loading data from URL:', error);
            }
        }
        
        // Hàm tự động in khi trang load xong (tùy chọn)
        function autoPrint() {
            const autoPrintParam = getUrlParameter('auto_print');
            if (autoPrintParam === 'true' || autoPrintParam === '1') {
                setTimeout(() => {
                    window.print();
                }, 2000); // Delay 2 giây để đảm bảo QR code đã load
            }
        }
        
        // Load dữ liệu khi trang được tải
        document.addEventListener('DOMContentLoaded', function() {
            loadDataFromUrl();
            autoPrint();
        });
        
        // Hàm test với dữ liệu mẫu (để development)
        function loadSampleData() {
            const sampleProducts = [
                {
                    sanpham: 'Laptop Dell Inspiron 15',
                    soluong: 1,
                    dongia: 15000000,
                    thanhtien: 15000000
                },
                {
                    sanpham: 'Chuột không dây Logitech',
                    soluong: 2,
                    dongia: 500000,
                    thanhtien: 1000000
                },
                {
                    sanpham: 'Bàn phím cơ Gaming',
                    soluong: 1,
                    dongia: 2000000,
                    thanhtien: 2000000
                }
            ];
            
            // Cập nhật thông tin mẫu
            document.getElementById('order-number').textContent = 'DH2024001';
            document.getElementById('order-date').textContent = '15/01/2024';
            document.getElementById('customer-name').textContent = 'Công ty TNHH ABC';
            document.getElementById('update-date').textContent = '15/01/2024';
            document.getElementById('subtotal').textContent = '18,000,000 VNĐ';
            document.getElementById('discount').textContent = '500,000 VNĐ';
            document.getElementById('total-amount').textContent = '17,500,000 VNĐ';
            
            // Cập nhật số tiền bằng chữ
            document.getElementById('amount-words').textContent = numberToWords(17500000);
            
            displayProducts(sampleProducts);
            
            // Tạo VietQR mẫu
            updateQRCode(17500000, 'DH2024001', '970415', '102893157888', 'PHAM DUC HUY');
        }
        
        // Load dữ liệu mẫu nếu không có tham số URL (để test)
        if (window.location.search === '') {
            document.addEventListener('DOMContentLoaded', function() {
                loadSampleData();
            });
        }
    </script>
</body>
</html>

