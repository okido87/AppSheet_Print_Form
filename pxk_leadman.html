<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phi·∫øu Xu·∫•t Kho</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body{font-family:'Times New Roman',Times,serif;font-size:11px;line-height:1.4;color:#000;background-color:#f4f4f4;margin:0;padding:0}@page{size:A4 landscape;margin:5mm}.invoice-container{position:relative;width:297mm;min-height:210mm;margin:0 auto;padding:5mm;background:#fff;box-sizing:border-box;overflow:hidden}.controls{text-align:center;padding:15px;background-color:#333}.controls button{background-color:#4CAF50;color:#fff;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;font-size:16px;margin:0 10px}.controls button:hover{background-color:#45a049}.controls button:disabled{background-color:#999;cursor:not-allowed}.header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;padding-bottom:5px;border-bottom:1px solid #ccc}.company-info{display:flex;align-items:center;gap:15px;flex:3}.logo{max-height:36px;flex-shrink:0}.company-details h3{margin:0;font-size:12px;text-transform:uppercase;font-weight:700}.company-details p{margin:0;font-size:10px}.qr-code-section{flex:1;text-align:right}.qr-code-section img{width:35px;height:35px}.title{text-align:center;margin-bottom:15px}.title h1{margin:0 0 2px;font-size:22px;font-weight:700;text-transform:uppercase}.title .subtitle{font-style:italic;margin:0;font-size:11px}.customer-info{display:flex;justify-content:space-between;gap:15px;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid #eee}.info-column{flex-basis:32%}.info-column p{margin:0 0 4px}.items-table{width:100%;border-collapse:collapse}.items-table td,.items-table th{border:1px solid #000;padding:4px;text-align:center;vertical-align:middle}.items-table th{background-color:#f2f2f2;font-weight:700}.items-table .text-left{text-align:left}.items-table .text-right{text-align:right}.items-table .stt-col{width:3%}.items-table .merged-col{width:25%}.items-table .dvt-col{width:4%}.items-table .sl-col{width:4%}.items-table .price-col{width:7%}.items-table .amount-col{width:10%}.items-table .item-code{color:#555;font-size:10px}.items-table .item-color{font-style:italic}.items-table tfoot .total-row{font-weight:700;background-color:#f2f2f2}.items-table tfoot td{font-weight:700}.items-table tfoot .amount-in-words{font-style:italic;text-align:right;border:none;padding-top:8px}.notes-section{vertical-align:top;text-align:left;font-weight:400;padding:8px!important}.payment-qr-cell{vertical-align:middle}.payment-qr-section{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:5px}.payment-qr-section img{width:90px;height:90px;flex-shrink:0}.payment-qr-section .payment-info{text-align:center}.payment-qr-section .payment-info p{margin:1px 0;font-size:10px}.payment-qr-section .payment-info p strong{font-weight:700;font-size:11px;text-transform:uppercase}.footer{margin-top:20px;padding-top:15px;display:flex;justify-content:space-around;text-align:center;width:100%}.signature{position:relative;width:150px}.signature .signature-title{margin:0;font-weight:700}.signature .signature-instruction{font-style:italic;font-size:10px;font-weight:400;margin:0}.signature .signature-name{margin-top:45px;font-weight:400;min-height:1.2em}.dynamic-value{color:#00f}.title .dynamic-value,.customer-info .dynamic-value{font-weight:700}.watermark{display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-45deg);font-size:100px;font-weight:700;color:rgba(255,0,0,.15);z-index:1000;pointer-events:none}.demo-signature{display:none;position:absolute;top:25px;left:50%;transform:translateX(-50%);width:120px;opacity:.8}@media print{body{background-color:#fff}.controls{display:none}.invoice-container{box-shadow:none;margin:0;padding:0}.items-table{page-break-inside:auto}.items-table tr{page-break-inside:avoid;page-break-after:auto}.items-table thead{display:table-header-group}.items-table tfoot{display:table-footer-group;page-break-inside:avoid}.footer{page-break-inside:avoid}.demo-mode .watermark,.demo-mode .demo-signature{display:block!important}}
    </style>
</head>
<body>
    <div class="controls">
        <button onclick="window.print()">üñ®Ô∏è In ngay</button>
        <button id="download-btn" onclick="downloadPDF()">üìÑ T·∫£i PDF</button>
    </div>
    <div class="invoice-container" id="invoice-content">
        <div id="watermark" class="watermark">PHI·∫æU DEMO</div>
        <div class="header">
            <div class="company-info">
                <img src="logo-manlead.jpg" alt="MANLEAD Logo" class="logo">
                <div class="company-details">
                    <h3>C√îNG TY TNHH ƒê·∫¶U T∆Ø V√Ä TH∆Ø∆†NG M·∫†I T&B VI·ªÜT NAM</h3>
                    <p>ƒê·ªãa ch·ªâ: 55 ƒê∆∞·ªùng H√πng V∆∞∆°ng II, Ph·ªë L√™ L·ª£i, P Nam B√¨nh, Ninh B√¨nh</p>
                </div>
            </div>
            <div class="qr-code-section">
                 <img id="qrSoPhieu" src="" alt="QR Code for Invoice No" crossorigin="anonymous">
            </div>
        </div>
        <div class="title">
            <h1>PHI·∫æU XU·∫§T KHO</h1>
            <p class="subtitle">
                S·ªë: <span id="soPhieu" class="dynamic-value"></span> | 
                <span id="ngay" class="dynamic-value"></span>
            </p>
        </div>
        <div class="customer-info">
             <div class="info-column">
                <p><strong>Nh√† ph√¢n ph·ªëi:</strong> <span id="nhaPhanPhoi" class="dynamic-value"></span></p>
                <p><strong>Nh√¢n vi√™n:</strong> <span id="nhanVien" class="dynamic-value"></span></p>
                <p><strong>SƒêT Nh√¢n vi√™n:</strong> <span id="sdtNhanVien" class="dynamic-value"></span></p>
             </div>
            <div class="info-column">
                <p><strong>Kh√°ch h√†ng:</strong> <span id="khachHang" class="dynamic-value"></span></p>
                <p><strong>ƒê·ªãa ch·ªâ:</strong> <span id="diaChi" class="dynamic-value"></span></p>
                <p><strong>Khu v·ª±c:</strong> <span id="khuVuc" class="dynamic-value"></span></p>
            </div>
             <div class="info-column">
                <p><strong>ƒê·ªëi t∆∞·ª£ng:</strong> <span id="doiTuong" class="dynamic-value"></span></p>
                <p><strong>Doanh s·ªë NVKD:</strong> <span id="doanhSoNVKD" class="dynamic-value"></span></p>
                <p><strong>%CKKH:</strong> <span id="ckkh" class="dynamic-value"></span> | <strong>%CKNPP:</strong> <span id="cknpp" class="dynamic-value"></span></p>
            </div>
        </div>
        <table class="items-table">
            <thead>
                <tr>
                    <th rowspan="2" class="stt-col">STT</th><th rowspan="2" class="text-left merged-col">T√™n h√†ng / M√£ h√†ng / M√†u</th><th rowspan="2" class="dvt-col">ƒêVT</th><th rowspan="2" class="sl-col">T·ªïng SL</th><th rowspan="2" class="text-right price-col">ƒê∆°n gi√°</th><th colspan="8">SIZE</th><th rowspan="2" class="text-right amount-col">Th√†nh ti·ªÅn (VNƒê)</th><th rowspan="2">Ghi ch√∫</th>
                </tr>
                <tr><th>29(S)</th><th>30(M)</th><th>31(L)</th><th>32(XL)</th><th>33(2XL)</th><th>34(3XL)</th><th>35(4XL)</th><th>36(5XL)</th></tr>
            </thead>
            <tbody id="chiTietDonHang"></tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="3" class="text-right">T·ªïng c·ªông:</td>
                    <td><span id="tongCongSoLuong" class="dynamic-value"></span></td><td></td>
                    <td><span id="tongSizeS" class="dynamic-value"></span></td>
                    <td><span id="tongSizeM" class="dynamic-value"></span></td>
                    <td><span id="tongSizeL" class="dynamic-value"></span></td>
                    <td><span id="tongSizeXL" class="dynamic-value"></span></td>
                    <td><span id="tongSizeXXL" class="dynamic-value"></span></td>
                    <td><span id="tongSize3XL" class="dynamic-value"></span></td>
                    <td><span id="tongSize4XL" class="dynamic-value"></span></td>
                    <td><span id="tongSize5XL" class="dynamic-value"></span></td>
                    <td class="text-right"><span id="tongThanhTien" class="dynamic-value"></span></td>
                    <td></td>
                </tr>
                <tr>
                    <td rowspan="5" colspan="4" class="notes-section" id="ghiChuFooterCell"></td>
                    <td rowspan="5" colspan="4" class="payment-qr-cell">
                        <div class="payment-qr-section">
                            <img id="qrThanhToan" src="" alt="VietQR Payment" crossorigin="anonymous">
                            <div class="payment-info">
                                <p><strong>Qu√©t m√£ ƒë·ªÉ thanh to√°n</strong></p>
                                <p>Ng√¢n h√†ng: <span id="nganHang" class="dynamic-value"></span></p>
                                <p>Ch·ªß TK: <span id="chuTaiKhoan" class="dynamic-value"></span></p>
                                <p>N·ªôi dung: <span id="ndChuyenKhoan" class="dynamic-value"></span></p>
                            </div>
                        </div>
                    </td>
                    <td colspan="5" class="text-right">C·ªông ti·ªÅn h√†ng:</td>
                    <td colspan="2" class="text-right"><span id="congTienHang" class="dynamic-value"></span></td>
                </tr>
                <tr>
                    <td colspan="5" class="text-right">Ti·ªÅn chi·∫øt kh·∫•u:</td>
                    <td colspan="2" class="text-right">(<span id="tienChietKhau" class="dynamic-value"></span>)</td>
                </tr>
                <tr>
                    <td colspan="5" class="text-right">T·ªïng c·ªông (tr∆∞·ªõc VAT):</td>
                    <td colspan="2" class="text-right"><span id="tongTruocVAT" class="dynamic-value"></span></td>
                </tr>
                <tr>
                    <td colspan="5" class="text-right" id="vatLabelCell">Thu·∫ø su·∫•t VAT:</td>
                    <td colspan="2" class="text-right"><span id="tienVAT" class="dynamic-value"></span></td>
                </tr>
                <tr>
                    <td colspan="5" class="text-right" style="font-size: 12px;">T·ªîNG TI·ªÄN THANH TO√ÅN:</td>
                    <td colspan="2" class="text-right" style="font-size: 12px;"><span id="tongThanhToan" class="dynamic-value"></span></td>
                </tr>
                <tr><td colspan="15" class="amount-in-words"><strong>Vi·∫øt b·∫±ng ch·ªØ:</strong> <span id="tongTienBangChu" class="dynamic-value"></span></td></tr>
            </tfoot>
        </table>
        <div id="final-notes-container" style="display: none;">
            <p><strong>Ghi ch√∫ cu·ªëi phi·∫øu:</strong> <span id="ghiChuCuoiPhieu" class="dynamic-value"></span></p>
        </div>
        <div class="footer">
            <div class="signature"><p class="signature-title">Ng∆∞·ªùi l·∫≠p phi·∫øu</p><p class="signature-instruction">(K√Ω, h·ªç t√™n)</p><img src="data:image/svg+xml;base64,..." class="demo-signature" alt="Demo Signature"><p class="signature-name"><span id="tenNguoiLap" class="dynamic-value"></span></p></div>
            <div class="signature"><p class="signature-title">Ng∆∞·ªùi duy·ªát</p><p class="signature-instruction">(K√Ω, h·ªç t√™n)</p><img src="data:image/svg+xml;base64,..." class="demo-signature" alt="Demo Signature"><p class="signature-name">&nbsp;</p></div>
            <div class="signature"><p class="signature-title">Th·ªß kho</p><p class="signature-instruction">(K√Ω, h·ªç t√™n)</p><img src="data:image/svg+xml;base64,..." class="demo-signature" alt="Demo Signature"><p class="signature-name">&nbsp;</p></div>
            <div class="signature"><p class="signature-title">Kh√°ch h√†ng</p><p class="signature-instruction">(K√Ω, h·ªç t√™n)</p><img src="data:image/svg+xml;base64,..." class="demo-signature" alt="Demo Signature"><p class="signature-name">&nbsp;</p></div>
        </div>
    </div>
    <script>
        function numberToVietnameseWords(n){const defaultNumbers=["kh√¥ng","m·ªôt","hai","ba","b·ªën","nƒÉm","s√°u","b·∫£y","t√°m","ch√≠n"];const units=["","ngh√¨n","tri·ªáu","t·ª∑","ngh√¨n t·ª∑","tri·ªáu t·ª∑"];function readThreeDigits(n,isFull){let hundred=Math.floor(n/100);let ten=Math.floor((n%100)/10);let one=n%10;let result=[];if(hundred>0||isFull){result.push(defaultNumbers[hundred],"trƒÉm")}if(ten===0&&one>0&&hundred>0){result.push("linh")}else if(ten===1){result.push("m∆∞·ªùi")}else if(ten>1){result.push(defaultNumbers[ten],"m∆∞∆°i")}if(one>0){if(ten===0&&hundred===0){result.push(defaultNumbers[one])}else if(ten>=1&&one===1){result.push("m·ªët")}else if(ten>=2&&one===5){result.push("lƒÉm")}else if(ten>=1&&one===5){result.push(defaultNumbers[one])}else if(one===4&&ten>1){result.push("t∆∞")}else{result.push(defaultNumbers[one])}}return result.join(" ")}if(n===0)return"Kh√¥ng ƒë·ªìng.";if(n<0)return"S·ªë √¢m "+numberToVietnameseWords(-n);let str=String(n);let parts=[];while(str.length>0){parts.unshift(str.slice(Math.max(0,str.length-3)));str=str.slice(0,Math.max(0,str.length-3))}let resultWords=[];for(let i=0;i<parts.length;i++){let num=parseInt(parts[i]);if(num>0){let chunkWords=readThreeDigits(num,i>0&&parts[i].length<3);resultWords.push(chunkWords,units[parts.length-1-i])}}let finalStr=resultWords.join(" ").trim();finalStr=finalStr.charAt(0).toUpperCase()+finalStr.slice(1);return finalStr+" ƒë·ªìng."}
        function populateTable(data){const tableBody=document.getElementById('chiTietDonHang');tableBody.innerHTML='';data.forEach((item,index)=>{const row=`<tr>
<td>${index+1}</td>
<td class="text-left">${item.ten||""} - <span class="item-code">${item.ma||""}</span> - <span class="item-color">${item.mau||""}</span></td>
<td>${item.dvt||""}</td><td>${item.sl||""}</td>
<td class="text-right">${item.donGia||""}</td>
<td>${item.s||""}</td><td>${item.m||""}</td><td>${item.l||""}</td><td>${item.xl||""}</td><td>${item.xxl||""}</td><td>${item['3xl']||""}</td><td>${item['4xl']||""}</td><td>${item['5xl']||""}</td>
<td class="text-right">${item.thanhTien||""}</td><td>${item.ghiChu||""}</td></tr>`;tableBody.innerHTML+=row})}
        document.addEventListener('DOMContentLoaded',function(){const urlParams=new URLSearchParams(window.location.search);const soPhieuParam=urlParams.get('soPhieu');if(soPhieuParam){document.title=`Phi·∫øu Xu·∫•t Kho - ${soPhieuParam}`;const fields=['soPhieu','ngay','nhaPhanPhoi','nhanVien','sdtNhanVien','khachHang','diaChi','khuVuc','doiTuong','doanhSoNVKD','ckkh','cknpp','tongCongSoLuong','tongSizeS','tongSizeM','tongSizeL','tongSizeXL','tongSizeXXL','tongSize3XL','tongSize4XL','tongSize5XL','tongThanhTien','congTienHang','tienChietKhau','tongTruocVAT','tienVAT','tongThanhToan','ghiChuCuoiPhieu','tenNguoiLap','nganHang','chuTaiKhoan','ndChuyenKhoan'];fields.forEach(id=>{const element=document.getElementById(id);if(element&&urlParams.has(id)){element.textContent=decodeURIComponent(urlParams.get(id))}});document.getElementById('qrSoPhieu').src=`https://api.qrserver.com/v1/create-qr-code/?size=35x35&data=${soPhieuParam}`;const qrAmount=urlParams.get('tongThanhToanNumeric')||'0';const qrAccountNo=urlParams.get('stk')||'';const qrAcqId=urlParams.get('acqId')||'970407';const qrAccountName=urlParams.get('chuTaiKhoan')||'';document.getElementById('qrThanhToan').src=`https://img.vietqr.io/image/${qrAcqId}-${qrAccountNo}-compact2.png?amount=${qrAmount}&addInfo=${encodeURIComponent(soPhieuParam)}&accountName=${encodeURIComponent(qrAccountName)}`;const vatRateParam=urlParams.get('vatRate');const vatLabelCell=document.getElementById('vatLabelCell');if(vatLabelCell&&vatRateParam){vatLabelCell.textContent=`Thu·∫ø su·∫•t VAT (${decodeURIComponent(vatRateParam)}%):`}const ghiChuText=document.getElementById('ghiChuCuoiPhieu').textContent;const ghiChuFooterCell=document.getElementById('ghiChuFooterCell');if(ghiChuFooterCell&&ghiChuText){ghiChuFooterCell.innerHTML=`<p><strong>Ghi ch√∫:</strong></p><p style="font-weight: normal; font-style: italic;">${ghiChuText}</p>`}const tongTienBangChuSpan=document.getElementById('tongTienBangChu');const tongTienNumeric=parseInt(qrAmount,10);if(tongTienBangChuSpan&&!isNaN(tongTienNumeric)){tongTienBangChuSpan.textContent=numberToVietnameseWords(tongTienNumeric)}try{const chiTietData=JSON.parse(decodeURIComponent(urlParams.get('chiTietHangHoa')));populateTable(chiTietData)}catch(e){console.error("L·ªói ph√¢n t√≠ch JSON chi ti·∫øt h√†ng h√≥a:",e);const tableBody=document.getElementById('chiTietDonHang');tableBody.innerHTML='<tr><td colspan="15" style="color:red;text-align:center;font-weight:bold;">L·ªñI: Kh√¥ng th·ªÉ ƒë·ªçc d·ªØ li·ªáu chi ti·∫øt ƒë∆°n h√†ng. Vui l√≤ng ki·ªÉm tra l·∫°i c√¥ng th·ª©c t·∫°o URL trong AppSheet.</td></tr>'}}else{document.body.classList.add('demo-mode');document.getElementById('watermark').style.display='block';document.querySelectorAll('.demo-signature').forEach(el=>el.style.display='block');const demoData={chiTietDonHang:[{ten:'H√†ng m·∫´u',ma:'MAU001',mau:'ƒêen',dvt:'C√°i',sl:1,donGia:'100.000',s:1,m:'',l:'',xl:'',xxl:'',"3xl":'',"4xl":'',"5xl":'',thanhTien:'100.000',ghiChu:'Ghi ch√∫ m·∫´u'}]};populateTable(demoData.chiTietDonHang);document.getElementById('tongTienBangChu').textContent=numberToVietnameseWords(9746352);const ghiChuText="Ghi ch√∫ ·ªü ch·∫ø ƒë·ªô demo.";document.getElementById('ghiChuFooterCell').innerHTML=`<p><strong>Ghi ch√∫:</strong></p><p style="font-weight: normal; font-style: italic;">${ghiChuText}</p>`}});
        function downloadPDF(){const downloadBtn=document.getElementById('download-btn');downloadBtn.textContent='ƒêang x·ª≠ l√Ω...';downloadBtn.disabled=true;const element=document.getElementById('invoice-content');const images=element.querySelectorAll('img');const imagePromises=[];images.forEach(img=>{const promise=new Promise((resolve)=>{if(img.complete&&img.naturalHeight!==0){resolve()}else{img.onload=resolve;img.onerror=resolve}});imagePromises.push(promise)});Promise.all(imagePromises).then(()=>{setTimeout(()=>{const opt={margin:[5,5,5,5],filename:`PhieuXuatKho_${document.getElementById('soPhieu').textContent}.pdf`,image:{type:'jpeg',quality:0.98},html2canvas:{scale:2,useCORS:true},jsPDF:{unit:'mm',format:'a4',orientation:'landscape'}};html2pdf().from(element).set(opt).save().then(()=>{downloadBtn.textContent='üìÑ T·∫£i PDF';downloadBtn.disabled=false})},200)})}
    </script>
</body>
</html>
