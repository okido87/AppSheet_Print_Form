<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes">
    <title>In Phi·∫øu ƒê·ªÅ Ngh·ªã T√†i Ch√≠nh</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Reset & Base Styles */
        body { font-family: 'Times New Roman', Times, serif; background-color: #e0e0e0; margin: 0; padding: 20px; color: #000; font-size: 11pt; }
        .lang-en { font-style: italic; font-size: 10pt; margin-left: 4px; }

        /* UPDATED: Data value colors and font weight */
        .data-value {
            color: #0066cc; /* Brighter Blue */
        }
        .info-grid .data-value, .form-no .data-value {
            font-weight: bold;
        }

        /* Header Controls */
        .controls { display: flex; justify-content: flex-end; align-items: center; gap: 15px; max-width: 210mm; margin: 0 auto 20px auto; padding: 15px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
        .controls #form-selector { padding: 10px 15px; border: 1px solid #ccc; border-radius: 5px; font-weight: bold; font-family: Arial, sans-serif; font-size: 1em; background-color: #f9f9f9; }
        .controls .actions { display: flex; gap: 10px; }
        .actions button { padding: 10px 15px; border: none; color: white; cursor: pointer; border-radius: 5px; font-weight: bold; font-family: Arial, sans-serif; white-space: nowrap; }
        .actions .print-btn { background-color: #28a745; }
        .actions .download-btn { background-color: #dc3545; }

        /* A4 Page Simulation */
        .page-preview-wrapper { margin: 0 auto; }
        .a4-page { width: 210mm; min-height: 297mm; margin: 0 auto; background: white; box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); box-sizing: border-box; padding: 15mm; position: relative; display: none; }
        .a4-page.active { display: block; }
        .watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 100px; font-weight: bold; color: rgba(255, 0, 0, 0.08); pointer-events: none; z-index: 1000; }
        
        /* Form Content - High Fidelity Styling */
        .form-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .company-name { font-weight: bold; }
        .form-no { border: 1px solid black; padding: 2px 8px; font-size: 10pt; }
        .form-title { text-align: center; font-size: 16pt; font-weight: bold; margin-top: 10px; margin-bottom: 5px; }
        .form-subtitle { text-align: center; font-size: 12pt; margin-bottom: 25px; }
        
        .info-grid { width: 100%; border-collapse: collapse; margin-bottom: 15px; table-layout: fixed; }
        .info-grid td { padding: 6px 0; vertical-align: middle; }
        .info-grid .label { padding-right: 8px; line-height: 1.4; white-space: normal; }
        .info-grid .value { width: 100%; border-bottom: 1px dotted #000; word-break: break-word; white-space: normal; }
        .info-grid .label-col1 { width: 150px; }
        .info-grid .value-col1 { width: auto; }
        /* UPDATED: Increased width of the Date/Ref No. label column */
        .info-grid .label-col2 { width: 120px; } 
        /* UPDATED: Decreased width of the Date/Ref No. value column */
        .info-grid .value-col2 { width: 100px; }
        
        .info-grid .value.checkbox-container { border-bottom: none; }
        .payment-methods { display: flex; flex-wrap: wrap; gap: 20px; }
        .payment-methods .method { display: flex; align-items: center; gap: 8px; }
        .checkbox-box { width: 16px; height: 16px; border: 1px solid black; display: flex; align-items: center; justify-content: center; font-weight: bold; font-family: sans-serif; }
        .details-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .details-table th, .details-table td { border: 1px solid black; padding: 5px; }
        .details-table thead { background-color: #e8e8e8; font-weight: bold; text-align: center; }
        .details-table tbody td { vertical-align: middle; height: 25px; }
        .details-table .number { text-align: right; }
        .details-table .center { text-align: center; }
        .summary-section { margin-bottom: 10px; line-height: 1.5; }
        .amount-in-words { font-weight: bold; font-style: italic; }
        .signature-area { margin-top: 40px; }
        /* UPDATED: Added align-items center for vertical alignment */
        .signature-row { display: flex; justify-content: space-around; align-items: center; margin-bottom: 40px; }
        .signature-block { width: 30%; text-align: center; }
        .signature-block .role { font-weight: bold; line-height: 1.4; }
        .signature-block .name-container { margin-top: 60px; font-weight: bold; }
        .signature-font { font-family: 'Brush Script MT', 'cursive', sans-serif; font-size: 1.6em; color: #000080; display: flex; align-items: center; justify-content: center; height: 40px; }
        .signature-block .name-container.signed .name-text { margin-top: 0; }
        
        @media screen and (max-width: 820px) { body { padding: 10px; background-color: #fff; } .controls { flex-direction: row; align-items: center; gap: 10px; max-width: 100%; } .controls #form-selector { flex-grow: 1; min-width: 150px; } .controls .actions { display: flex; gap: 10px; } .controls .actions button { flex-shrink: 0; padding: 10px; font-size: 0.9em; } .a4-page { transform: scale(calc(100vw / 220mm)); transform-origin: top left; box-shadow: none; margin: 0; } .page-preview-wrapper { height: calc(297mm * (100vw / 220mm)); width: 100vw; margin-left: -10px; } }
        @media print { body { background-color: #fff; padding: 0; margin: 0; } .controls, .no-print { display: none; } .page-preview-wrapper { margin: 0; height: auto; width: auto; } .a4-page { width: 100%; min-height: 0; margin: 0; border: none; box-shadow: none; padding: 0; transform: none; } }
        @page { size: A4; margin: 10mm; }
    </style>
</head>
<body>

<header class="controls no-print">
    <select id="form-selector">
        <option value="fino1">ƒê·ªÅ ngh·ªã Thanh to√°n (FINO1)</option>
        <option value="fino2">ƒê·ªÅ ngh·ªã T·∫°m ·ª©ng (FINO2)</option>
        <option value="fino4">ƒê·ªÅ ngh·ªã Thu Ho√†n ·ª©ng (FINO4)</option>
    </select>
    <div class="actions">
        <button class="print-btn">üñ®Ô∏è In Phi·∫øu</button>
        <button class="download-btn">üìÑ T·∫£i v·ªÅ PDF</button>
    </div>
</header>

<div class="page-preview-wrapper"><div id="form-fino1" class="a4-page"></div></div>
<div class="page-preview-wrapper"><div id="form-fino2" class="a4-page"></div></div>
<div class="page-preview-wrapper"><div id="form-fino4" class="a4-page"></div></div>

<script>
const demoData = {
    fino1:{request:{request_type:"PAYMENT",applicant_name:"TR·∫¶N TH·ªä DUY√äN ANH",department:"K·∫ø to√°n",request_date:"24-Aug-25",ref_no:"REF-00123",
    vendor_name:"C√¥ng ty TNHH Cung C·∫•p Thi·∫øt B·ªã v√† D·ªãch V·ª• K·ªπ Thu·∫≠t Adeline To√†n C·∫ßu",
    payment_method:"VISA",
    settlement_deadline: "30-Sep-25",
    total_amount:3550000,amount_in_words:"Ba tri·ªáu nƒÉm trƒÉm nƒÉm m∆∞∆°i ng√†n ƒë·ªìng",attachments:"H√≥a ƒë∆°n kh√°ch s·∫°n, h√≥a ƒë∆°n taxi",signatures:{director:"L√™ Vi·ªát H√πng",chief_accountant:"Nguy·ªÖn Th·ªã Lan Anh",head_of_dept:"Tr·∫ßn VƒÉn B√¨nh",accountant:"L√™ Minh Ch√¢u"}},details:[{line_no:1,description:"Thanh to√°n ti·ªÅn kh√°ch s·∫°n Adeline (14-16/07)",amount:2700000,remark:"H√≥a ƒë∆°n #123"},{line_no:2,description:"Chi ph√≠ ƒÉn u·ªëng theo c√¥ng t√°c ph√≠",amount:500000,remark:"2 ng√†y"},{line_no:3,description:"Chi ph√≠ di chuy·ªÉn taxi s√¢n bay",amount:350000,remark:"C√≥ h√≥a ƒë∆°n Grab"}]},
    fino2:{request:{request_type:"ADVANCE",applicant_name:"NGUY·ªÑN VƒÇN AN",department:"Kinh doanh",request_date:"22-Aug-17",ref_no:"REF-00124",balance:0,settlement_deadline:"31/09/2017",
    payment_method: "BANK",
    total_amount:9500000,amount_in_words:"Ch√≠n tri·ªáu nƒÉm trƒÉm ng√†n ƒë·ªìng",signatures:{director:"L√™ Vi·ªát H√πng",chief_accountant:"Nguy·ªÖn Th·ªã Lan Anh",head_of_dept:"Tr·∫ßn VƒÉn B√¨nh",accountant:"L√™ Minh Ch√¢u"}},details:[{line_no:1,description:"T·∫°m ·ª©ng mua m√†n h√¨nh Dell U2723QE",amount:7500000,remark:"Theo b√°o gi√° Phong V≈©"},{line_no:2,description:"T·∫°m ·ª©ng mua b√†n ph√≠m c∆°",amount:2000000,remark:"Cho nh√¢n vi√™n m·ªõi"}]},
    fino4:{request:{request_type:"REFUND",applicant_name:"TR·∫¶N TH·ªä DUY√äN ANH",department:"K·∫ø to√°n",request_date:"24-Aug-25",ref_no:"REF-00125",payment_method:"CASH",
    settlement_deadline: "N/A",
    total_amount:750000,amount_in_words:"B·∫£y trƒÉm nƒÉm m∆∞∆°i ng√†n ƒë·ªìng",attachments:"Kh√¥ng c√≥",signatures:{director:"L√™ Vi·ªát H√πng",chief_accountant:"Nguy·ªÖn Th·ªã Lan Anh",head_of_dept:"Tr·∫ßn VƒÉn B√¨nh",requestor:"Tr·∫ßn Th·ªã Duy√™n Anh",accountant:"L√™ Minh Ch√¢u"}},details:[{line_no:1,description:"Thu ho√†n ·ª©ng c√¥ng t√°c ph√≠ ng√†y 20/08",amount:750000,remark:"Ho√†n ti·ªÅn th·ª´a sau quy·∫øt to√°n"}]}
};

function formatCurrency(num) { if (num === null || num === undefined || num === '') return ''; return Number(num).toLocaleString('vi-VN'); }

// This function builds the entire HTML string with data already in it.
function buildAndPopulateForm(formType, data, isDemo = false) {
    const { request, details } = data;
    const isFino1 = formType === 'fino1', isFino2 = formType === 'fino2', isFino4 = formType === 'fino4';
    let title = '', subtitle = '', detailsTitle = 'S·ªë ti·ªÅn / <span class="lang-en">Amount (VND)</span>';
    if(isFino1) { title = 'ƒê·ªÄ NGH·ªä THANH TO√ÅN'; subtitle = 'PAYMENT REQUEST'; }
    if(isFino2) { title = 'PHI·∫æU ƒê·ªÄ NGH·ªä T·∫†M ·ª®NG'; subtitle = 'REQUEST FOR ADVANCE'; detailsTitle = 'S·ªë ti·ªÅn / <span class="lang-en">Amount</span>';}
    if(isFino4) { title = 'ƒê·ªÄ NGH·ªä THU HO√ÄN ·ª®NG'; subtitle = 'REFUND ADVANCE PAYMENT REQUEST';}

    let infoGridHTML = `
        <tr><td class="label label-col1">Ng∆∞·ªùi ƒë·ªÅ ngh·ªã / <span class="lang-en">(Applicant)</span>:</td><td class="value value-col1 data-value">${request.applicant_name || ''}</td><td class="label label-col2">Ng√†y / <span class="lang-en">(Date)</span>:</td><td class="value value-col2 data-value">${request.request_date || ''}</td></tr>
        <tr><td class="label label-col1">B·ªô ph·∫≠n / <span class="lang-en">(Dept)</span>:</td><td class="value value-col1 data-value">${request.department || ''}</td><td class="label label-col2">S·ªë / <span class="lang-en">(Ref No.)</span>:</td><td class="value value-col2 data-value">${request.ref_no || ''}</td></tr>`;
    if (isFino2) {
        infoGridHTML += `<tr><td class="label label-col1">S·ªë d∆∞ t·∫°m ·ª©ng / <span class="lang-en">(Advance balance)</span>:</td><td class="value value-col1 data-value">${formatCurrency(request.balance)}</td><td class="label label-deadline">H·∫°n thanh to√°n / <span class="lang-en">(Deadline for settlement)</span>:</td><td class="value value-col2 data-value">${request.settlement_deadline || ''}</td></tr>
                         <tr><td class="label">Ph∆∞∆°ng th·ª©c thanh to√°n / <span class="lang-en">(Method of Payment)</span>:</td><td colspan="3" class="value checkbox-container"><div class="payment-methods">
                            <div class="method"><span class="checkbox-box data-value">${request.payment_method?.toLowerCase() === 'cash' ? 'X' : ''}</span> Cash</div>
                            <div class="method"><span class="checkbox-box data-value">${request.payment_method?.toLowerCase() === 'bank' ? 'X' : ''}</span> Bank transfer</div>
                         </div></td></tr>`;
    } else if (isFino1) {
        infoGridHTML += `<tr><td class="label label-col1">T√™n nh√† cung c·∫•p / <span class="lang-en">(Vendor name)</span>:</td><td class="value value-col1 data-value">${request.vendor_name || ''}</td><td class="label label-col2">H·∫°n thanh to√°n / <span class="lang-en">(Deadline)</span>:</td><td class="value value-col2 data-value">${request.settlement_deadline || ''}</td></tr>
                         <tr><td class="label">Ph∆∞∆°ng th·ª©c thanh to√°n / <span class="lang-en">(Method of Payment)</span>:</td><td colspan="3" class="value checkbox-container"><div class="payment-methods">
                            <div class="method"><span class="checkbox-box data-value">${request.payment_method?.toLowerCase() === 'cash' ? 'X' : ''}</span> Cash</div>
                            <div class="method"><span class="checkbox-box data-value">${request.payment_method?.toLowerCase() === 'visa' ? 'X' : ''}</span> VISA</div>
                            <div class="method"><span class="checkbox-box data-value">${request.payment_method?.toLowerCase() === 'bank' ? 'X' : ''}</span> Bank transfer</div>
                            <div class="method"><span class="checkbox-box data-value">${request.payment_method?.toLowerCase() === 'debt' ? 'X' : ''}</span> Debt offset</div>
                         </div></td></tr>`;
    } else if (isFino4) {
         infoGridHTML += `<tr><td class="label label-col1">Ph∆∞∆°ng th·ª©c thanh to√°n / <span class="lang-en">(Method of Payment)</span>:</td><td class="value value-col1 checkbox-container"><div class="payment-methods">
                            <div class="method"><span class="checkbox-box data-value">${request.payment_method?.toLowerCase() === 'cash' ? 'X' : ''}</span> Cash</div>
                            <div class="method"><span class="checkbox-box data-value">${request.payment_method?.toLowerCase() === 'bank' ? 'X' : ''}</span> Bank transfer</div>
                            </div></td><td class="label label-col2">H·∫°n thanh to√°n / <span class="lang-en">(Deadline)</span>:</td><td class="value value-col2 data-value">${request.settlement_deadline || ''}</td></tr>`;
    }

    let detailsHTML = '';
    details.forEach(item => { detailsHTML += `<tr><td class="center data-value">${item.line_no || ''}</td><td class="data-value">${item.description}</td><td class="number data-value">${formatCurrency(item.amount)}</td><td class="data-value">${item.remark}</td></tr>`; });
    const DEFAULT_TABLE_ROWS = 3; const rowsToAdd = Math.max(0, DEFAULT_TABLE_ROWS - details.length);
    for (let i = 0; i < rowsToAdd; i++) { detailsHTML += '<tr><td>&nbsp;</td><td></td><td></td><td></td></tr>'; }

    const buildSignature = (roleName, name) => {
        const roleHTML = `<div class="role">${roleName}</div>`;
        if (!name) return `${roleHTML}<div class="name-container"><div class="name-text"></div></div>`;
        if (isDemo) {
            const lastName = name.split(' ').pop();
            return `${roleHTML}<div class="name-container signed"><div class="signature-font">${lastName}</div><div class="name-text data-value">${name.toUpperCase()}</div></div>`;
        }
        return `${roleHTML}<div class="name-container"><div class="name-text data-value">${name.toUpperCase()}</div></div>`;
    };
    let sigDirectorHTML = buildSignature('Gi√°m ƒë·ªëc / <span class="lang-en">Director</span>', isDemo || isFino4 ? (isDemo ? request.signatures.director : 'L√ä VI·ªÜT H√ôNG') : null);
    let sigChiefAccHTML = buildSignature('K·∫ø to√°n tr∆∞·ªüng / <span class="lang-en">Chief accountant</span>', isDemo ? request.signatures.chief_accountant : null);
    let sigHeadDeptHTML = buildSignature('Tr∆∞·ªüng b·ªô ph·∫≠n / <span class="lang-en">Head of dept.)</span>', isDemo ? request.signatures.head_of_dept : null);
    let sigRequestorHTML = buildSignature('Ng∆∞·ªùi ƒë·ªÅ ngh·ªã / <span class="lang-en">Requestor</span>', isDemo || isFino4 ? (isDemo ? request.applicant_name : 'TR·∫¶N TH·ªä DUY√äN ANH') : request.applicant_name);
    let sigAccountantHTML = buildSignature('K·∫ø to√°n thanh to√°n / <span class="lang-en">Accountant</span>', isDemo ? request.signatures.accountant : null);

    const finalHTML = `
        <div class="watermark">${isDemo ? 'B·∫¢N DEMO' : ''}</div>
        <div class="form-header"><div class="company-name">KARCHER VIETNAM</div><div class="form-no">Form no: <span class="data-value">${formType.toUpperCase()}</span></div></div>
        <h1 class="form-title">${title}</h1><h2 class="form-subtitle lang-en">${subtitle}</h2><table class="info-grid">${infoGridHTML}</table>
        ${isFino2 ? `<p style="font-weight:bold;">Chi ti·∫øt t·∫°m ·ª©ng / <span class="lang-en">(Advance detail)</span>:</p>` : ''}
        <table class="details-table"><thead><tr><th style="width:9%">STT / <span class="lang-en">No</span></th><th style="width:46%">Di·ªÖn gi·∫£i / <span class="lang-en">Description</span></th><th style="width:25%">${detailsTitle}</th><th style="width:20%">Ghi ch√∫ / <span class="lang-en">Remark</span></th></tr></thead><tbody>${detailsHTML}</tbody><tfoot><tr><td colspan="2" style="text-align:right; font-weight:bold;">T·ªîNG C·ªòNG / <span class="lang-en">TOTAL</span></td><td class="number data-value" style="font-weight:bold;">${formatCurrency(request.total_amount)}</td><td></td></tr></tfoot></table>
        <div class="summary-section"><strong>B·∫±ng ch·ªØ / <span class="lang-en">(In words)</span>:</strong> <span class="amount-in-words data-value">${request.amount_in_words || ''}</span></div>
        ${!isFino2 ? `<div class="summary-section"><strong>Ch·ª©ng t·ª´ ƒë√≠nh k√®m / <span class="lang-en">(Supporting document)</span>:</strong> <span class="data-value">${request.attachments || ''}</span></div>` : ''}
        <div class="signature-area">
            <div class="signature-row"><div class="signature-block">${sigDirectorHTML}</div><div class="signature-block">${sigChiefAccHTML}</div><div class="signature-block">${sigHeadDeptHTML}</div></div>
            <div class="signature-row"><div class="signature-block">${sigRequestorHTML}</div><div class="signature-block">${sigAccountantHTML}</div><div class="signature-block"></div></div>
        </div>`;
    
    document.getElementById(`form-${formType}`).innerHTML = finalHTML;
}

document.addEventListener('DOMContentLoaded', function() {
    const formSelector = document.getElementById('form-selector');
    const urlParams = new URLSearchParams(window.location.search);
    const appSheetDataParam = urlParams.get('data');
    const processData = (data) => {
        let activeFormId = ''; const formType = data.request.request_type;
        if (formType === 'PAYMENT') { activeFormId = 'fino1'; } else if (formType === 'ADVANCE') { activeFormId = 'fino2'; } else if (formType === 'REFUND') { activeFormId = 'fino4'; } else { loadDemoData(); return; }
        buildAndPopulateForm(activeFormId, data, false);
        document.querySelectorAll('.page-preview-wrapper').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.a4-page').forEach(el => el.classList.remove('active'));
        const activePageWrapper = document.getElementById(`form-${activeFormId}`).parentElement;
        activePageWrapper.style.display = 'block'; activePageWrapper.querySelector('.a4-page').classList.add('active');
        formSelector.value = activeFormId; formSelector.disabled = true;
    };
    const loadDemoData = () => {
        buildAndPopulateForm('fino1', demoData.fino1, true); 
        buildAndPopulateForm('fino2', demoData.fino2, true); 
        buildAndPopulateForm('fino4', demoData.fino4, true);
        document.querySelectorAll('.page-preview-wrapper').forEach(el => el.style.display = 'block');
        document.querySelectorAll('.a4-page').forEach(el => el.classList.remove('active'));
        document.getElementById('form-fino1').classList.add('active');
        formSelector.value = 'fino1'; formSelector.disabled = false;
    };
    if (appSheetDataParam) { try { const realData = JSON.parse(atob(decodeURIComponent(appSheetDataParam))); processData(realData); } catch (e) { console.error("Error parsing AppSheet data:", e); alert("L·ªói d·ªØ li·ªáu ƒë·∫ßu v√†o. Hi·ªÉn th·ªã d·ªØ li·ªáu demo."); loadDemoData(); } } else { loadDemoData(); }
    formSelector.addEventListener('change', (e) => { const formId = e.target.value; document.querySelectorAll('.a4-page').forEach(el => el.classList.remove('active')); document.getElementById(`form-${formId}`).classList.add('active'); });
    document.querySelector('.print-btn').addEventListener('click', () => window.print());
    document.querySelector('.download-btn').addEventListener('click', () => {
        const activePage = document.querySelector('.a4-page.active');
        let data = {}; const activeId = activePage.id.replace('form-', '');
        if (appSheetDataParam) { data = JSON.parse(atob(decodeURIComponent(appSheetDataParam))); } else { data = demoData[activeId]; }
        const filename = `${activeId.toUpperCase()}_${data.request.applicant_name.replace(/\s/g, '_')}_${data.request.request_date.replace(/[^a-zA-Z0-9]/g, '-')}.pdf`;
        
        const opt = { 
            margin: [7.5, 7.5, 7.5, 7.5],
            filename, 
            image: { type: 'jpeg', quality: 1 }, 
            html2canvas: { scale: 2, useCORS: true, letterRendering: true, x: 0, y: 0, scrollX: 0, scrollY: 0, width: activePage.scrollWidth, windowWidth: activePage.scrollWidth }, 
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        const watermark = activePage.querySelector('.watermark'); 
        const originalDisplay = watermark.style.display; 
        if (appSheetDataParam) watermark.style.display = 'none';
        
        html2pdf().from(activePage).set(opt).save().finally(() => {
            watermark.style.display = originalDisplay;
        });
    });
});
</script>

</body>
</html>
